<!DOCTYPE html>
<!-- saved from url=(0048)file:///Users/Ray/Downloads/geofence-app_10.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CountyZone Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link href="./index_files/css2" rel="stylesheet">
<link rel="stylesheet" href="./index_files/leaflet.css">
<script src="./index_files/leaflet.js"></script>
<style>
  :root {
    --bg: #0a0f1a; --panel: #111827; --panel2: #1a2235; --border: #1e2d45;
    --accent: #00e5ff; --accent2: #ff6b35; --green: #00ff88; --yellow: #f7c948;
    --text: #e8f0fe; --muted: #6b7a99;
    --font-mono: 'Space Mono', monospace; --font-sans: 'DM Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-sans); height: 100vh; display: grid; grid-template-rows: 56px 1fr; grid-template-columns: 320px 1fr; overflow: hidden; }

  /* â”€â”€ HEADER â”€â”€ */
  header { grid-column: 1 / -1; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 10px; flex-wrap: nowrap; overflow: hidden; }
  .logo { font-family: var(--font-mono); font-size: 14px; font-weight: 700; letter-spacing: 0.06em; color: var(--accent); white-space: nowrap; }
  .logo span { color: var(--accent2); }
  .hdiv { width: 1px; height: 22px; background: var(--border); flex-shrink: 0; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); transition: background 0.3s; flex-shrink: 0; }
  .status-dot.on { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .status-text { font-size: 11px; color: var(--muted); font-family: var(--font-mono); white-space: nowrap; }
  .header-actions { margin-left: auto; display: flex; gap: 6px; flex-shrink: 0; }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn { padding: 6px 11px; border-radius: 6px; border: none; font-family: var(--font-mono); font-size: 11px; font-weight: 700; cursor: pointer; letter-spacing: 0.04em; transition: all 0.15s; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #33eaff; transform: translateY(-1px); }
  .btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
  .btn-secondary:hover { background: rgba(0,229,255,0.08); }
  .btn-warning { background: transparent; color: var(--yellow); border: 1px solid var(--yellow); }
  .btn-warning:hover { background: rgba(247,201,72,0.08); }
  .btn-danger { background: transparent; color: var(--accent2); border: 1px solid var(--accent2); }
  .btn-danger:hover { background: rgba(255,107,53,0.08); }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ SIDEBAR â”€â”€ */
  aside { background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s; }
  aside.collapsed { transform: translateX(-100%); position: absolute; z-index: 500; height: calc(100vh - 56px); top: 56px; }
  .sidebar-section { padding: 13px 15px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .section-label { font-family: var(--font-mono); font-size: 10px; font-weight: 700; letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; }

  select, input[type="text"] { width: 100%; background: var(--panel2); border: 1px solid var(--border); color: var(--text); padding: 7px 10px; border-radius: 6px; font-family: var(--font-sans); font-size: 13px; outline: none; transition: border-color 0.15s; margin-bottom: 6px; }
  select:focus, input:focus { border-color: var(--accent); }
  select option { background: #1a2235; }

  .stats-bar { display: flex; flex-shrink: 0; }
  .stat { flex: 1; padding: 9px 6px; border-right: 1px solid var(--border); text-align: center; }
  .stat:last-child { border-right: none; }
  .stat-val { font-family: var(--font-mono); font-size: 16px; font-weight: 700; color: var(--accent); }
  .stat-label { font-size: 9px; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }

  .color-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
  .color-swatch { width: 22px; height: 22px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: all 0.12s; }
  .color-swatch:hover { transform: scale(1.2); }
  .color-swatch.sel { border-color: white; }

  .draw-btn { width: 100%; margin-bottom: 5px; padding: 8px 11px; background: var(--panel2); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-family: var(--font-mono); font-size: 11px; font-weight: 700; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px; transition: all 0.15s; letter-spacing: 0.04em; }
  .draw-btn:hover { border-color: var(--accent); color: var(--accent); }
  .draw-btn.active { border-color: var(--accent); background: var(--accent); color: #000; }
  .cancel-btn { width: 100%; padding: 7px 11px; background: transparent; border: 1px solid var(--accent2); color: var(--accent2); border-radius: 6px; font-family: var(--font-mono); font-size: 11px; font-weight: 700; cursor: pointer; display: none; transition: all 0.15s; }
  .cancel-btn:hover { background: rgba(255,107,53,0.1); }
  .help-tip { font-size: 11px; color: var(--muted); font-family: var(--font-mono); line-height: 1.6; margin-top: 5px; }

  /* zone save/load row */
  .zone-file-row { display: flex; gap: 6px; margin-top: 8px; }
  .zone-file-row .btn { flex: 1; text-align: center; font-size: 10px; padding: 6px 4px; }

  .polygons-list { flex: 1; overflow-y: auto; padding: 9px; }
  .polygon-item { background: var(--panel2); border: 1px solid var(--border); border-radius: 7px; padding: 8px 10px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: border-color 0.15s; }
  .polygon-item:hover { border-color: var(--accent); }
  .poly-color { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
  .poly-info { flex: 1; min-width: 0; }
  .poly-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .poly-count { font-size: 11px; color: var(--muted); font-family: var(--font-mono); }
  .poly-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; padding: 2px 4px; border-radius: 3px; transition: color 0.12s; }
  .poly-btn:hover { color: var(--accent2); }
  .empty-state { text-align: center; color: var(--muted); font-size: 12px; padding: 24px 10px; line-height: 1.8; font-family: var(--font-mono); }

  /* â”€â”€ MAP â”€â”€ */
  #map { width: 100%; height: 100%; background: #e8e0d8; }
  .map-wrap { position: relative; overflow: hidden; }
  #drawHint { position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); background: rgba(10,15,26,0.92); border: 1px solid var(--accent); color: var(--accent); font-family: var(--font-mono); font-size: 12px; padding: 10px 18px; border-radius: 8px; z-index: 1000; display: none; pointer-events: none; white-space: nowrap; }

  /* sidebar toggle button (mobile) */
  #sidebarToggle { display: none; background: var(--panel); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 6px 10px; font-size: 16px; cursor: pointer; }

  /* share banner */
  #shareBanner { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(10,15,26,0.95); border: 1px solid var(--green); color: var(--green); font-family: var(--font-mono); font-size: 11px; padding: 10px 16px; border-radius: 8px; z-index: 1000; display: none; max-width: 90%; text-align: center; cursor: pointer; }
  #shareBanner:hover { background: rgba(0,255,136,0.08); }

  /* â”€â”€ MODALS â”€â”€ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.72); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 440px; max-width: 95vw; max-height: 90vh; overflow-y: auto; transform: translateY(10px); transition: transform 0.2s; }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h2 { font-family: var(--font-mono); font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 5px; letter-spacing: 0.05em; }
  .modal p { font-size: 13px; color: var(--muted); margin-bottom: 14px; line-height: 1.6; }
  .modal label { font-size: 11px; color: var(--muted); font-family: var(--font-mono); display: block; margin-bottom: 4px; margin-top: 10px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; flex-wrap: wrap; }
  .gs-help { font-size: 11px; color: var(--muted); margin-top: 3px; line-height: 1.5; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast { position: fixed; bottom: 22px; right: 22px; background: var(--panel); border: 1px solid var(--border); border-left: 3px solid var(--accent); padding: 11px 16px; border-radius: 8px; font-size: 12px; font-family: var(--font-mono); z-index: 9999; transform: translateX(120%); transition: transform 0.3s; max-width: 320px; line-height: 1.5; }
  .toast.show { transform: translateX(0); }
  .toast.error { border-left-color: var(--accent2); }
  .toast.success { border-left-color: var(--green); }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .leaflet-container { background: #e8e0d8 !important; }
  .tile-toggle select {
    background: white;
    border: 2px solid rgba(0,0,0,0.3);
    border-radius: 6px;
    padding: 6px 12px;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    outline: none;
    color: #333;
    min-width: 130px;
  }
  .tile-toggle select:hover { border-color: rgba(0,0,0,0.5); }
  .leaflet-bar a { background: var(--panel) !important; color: var(--text) !important; border-color: var(--border) !important; }
  .leaflet-bar a:hover { background: var(--panel2) !important; }
  .poly-tooltip { background: rgba(10,15,26,0.88) !important; border: 1px solid #1e2d45 !important; color: #e8f0fe !important; font-family: 'Space Mono', monospace !important; font-size: 11px !important; padding: 3px 8px !important; border-radius: 4px !important; box-shadow: none !important; }
  .poly-tooltip::before { display: none !important; }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width: 700px) {
    body { grid-template-columns: 1fr; }
    aside { position: absolute; top: 56px; left: 0; height: calc(100vh - 56px); width: 300px; z-index: 500; transform: translateX(-100%); }
    aside.open { transform: translateX(0); }
    .map-wrap { grid-column: 1; }
    #sidebarToggle { display: block; }
    .status-text { display: none; }
  }
</style>
</head>
<body>

<header>
  <button id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">â˜°</button>
  <div class="logo">COUNTY<span>ZONE</span> PRO</div>
  <div class="hdiv"></div>
  <div class="status-dot" id="statusDot"></div>
  <div class="status-text" id="statusText">NOT CONNECTED</div>
  <div class="header-actions">
    <button class="btn btn-ghost" onclick="shareURL()" title="Copy shareable link">ğŸ”— Share</button>
    <button class="btn btn-secondary" onclick="openSheetsModal()">âš™ Sheets</button>
    <button class="btn btn-primary" onclick="runAssignment()">â–¶ Assign</button>
    <button class="btn btn-danger" onclick="exportCSV()">â†“ CSV</button>
  </div>
</header>

<aside id="sidebar">
  <!-- Location -->
  <div class="sidebar-section">
    <div class="section-label">Location</div>
    <select id="stateSelect" onchange="loadCounties()">
      <option value="">â€” Select State â€”</option>
    <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option></select>
    <select id="countySelect" onchange="loadCounty()">
      <option value="">â€” Select County â€”</option>
    </select>
  </div>

  <!-- Stats -->
  <div class="stats-bar" style="border-bottom:1px solid var(--border)">
    <div class="stat"><div class="stat-val" id="statPolygons">0</div><div class="stat-label">Zones</div></div>
    <div class="stat"><div class="stat-val" id="statProps">0</div><div class="stat-label">Props</div></div>
    <div class="stat"><div class="stat-val" id="statAssigned">0</div><div class="stat-label">Assigned</div></div>
  </div>

  <!-- Draw -->
  <div class="sidebar-section">
    <div class="section-label">Draw Zones</div>
    <button class="draw-btn" id="btnPolygon" onclick="startDraw(&#39;polygon&#39;)">
      <span style="font-size:14px">â¬¡</span> Freeform Polygon
    </button>
    <button class="draw-btn" id="btnRectangle" onclick="startDraw(&#39;rectangle&#39;)">
      <span style="font-size:14px">â¬œ</span> Rectangle
    </button>
    <button class="cancel-btn" id="btnCancel" onclick="cancelDraw()">âœ• Cancel Drawing</button>
    <div class="help-tip" id="drawHelp">Select a mode above, then draw on the map.</div>
    <div class="section-label" style="margin-top:10px">Zone Color</div>
    <div class="color-row" id="colorRow"><div class="color-swatch sel" style="background: rgb(0, 229, 255);"></div><div class="color-swatch" style="background: rgb(255, 107, 53);"></div><div class="color-swatch" style="background: rgb(0, 255, 136);"></div><div class="color-swatch" style="background: rgb(247, 201, 72);"></div><div class="color-swatch" style="background: rgb(192, 132, 252);"></div><div class="color-swatch" style="background: rgb(251, 113, 133);"></div><div class="color-swatch" style="background: rgb(56, 189, 248);"></div><div class="color-swatch" style="background: rgb(163, 230, 53);"></div></div>

    <!-- Save / Load zones file -->
    <div class="zone-file-row">
      <button class="btn btn-warning" onclick="saveZonesFile()" title="Download zones as a file">ğŸ’¾ Save Zones</button>
      <button class="btn btn-ghost" onclick="loadZonesFile()" title="Load a previously saved zones file">ğŸ“‚ Load Zones</button>
    </div>
    <input type="file" id="zoneFileInput" accept=".json" style="display:none" onchange="importZonesFile(event)">
  </div>

  <!-- Zones list -->
  <div style="padding:9px 14px 0; border-top:1px solid var(--border); display:flex; align-items:center; gap:8px; flex-shrink:0;">
    <span class="section-label" style="margin:0">Saved Zones</span>
    <span style="background:rgba(0,229,255,0.1);color:var(--accent);font-family:var(--font-mono);font-size:10px;padding:2px 7px;border-radius:4px" id="zoneCount">0</span>
    <button class="btn btn-ghost" style="margin-left:auto;font-size:10px;padding:3px 7px" onclick="clearAllZones()">Clear All</button>
  </div>
  <div class="polygons-list" id="polygonsList"><div class="empty-state">No zones yet.<br>Draw on the map or load<br>a saved zones file.</div></div>
</aside>

<div class="map-wrap">
  <div id="map" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative;"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(0px, 0px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 22; transform: translate3d(0px, 0px, 0px) scale(1);"><img alt="" src="./index_files/5@2x" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(882px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(882px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(1)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(626px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(2)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1138px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(1)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(626px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(2)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1138px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(882px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(882px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(1)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(626px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(2)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1138px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(1)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(626px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(2)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1138px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(3)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(370px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(4)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1394px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(3)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(370px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(4)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1394px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(882px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(3)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(370px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(4)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1394px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(3)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(370px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(4)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1394px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(882px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(1)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(626px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(2)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1138px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(1)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(626px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(2)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1138px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(5)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(114px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(6)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1650px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(5)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(114px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(6)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1650px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(3)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(370px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(4)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1394px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(3)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(370px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(4)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1394px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(5)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(114px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(6)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1650px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(5)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(114px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(6)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1650px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(5)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(114px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(6)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1650px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(5)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(114px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(6)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1650px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(7)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-142px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/5@2x(8)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1906px, 300px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(7)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-142px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/6@2x(8)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1906px, 556px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(7)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-142px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/4@2x(8)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1906px, 44px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(7)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-142px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/7@2x(8)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1906px, 812px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(7)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-142px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/3@2x(8)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1906px, -212px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(7)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-142px, 1068px, 0px); opacity: 1;"><img alt="" src="./index_files/8@2x(8)" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1906px, 1068px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-overlay-pane"></div><div class="leaflet-pane leaflet-shadow-pane"></div><div class="leaflet-pane leaflet-marker-pane"></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(928.996px, 1558.06px, 0px) scale(8);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="file:///Users/Ray/Downloads/geofence-app_10.html#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a><a class="leaflet-control-zoom-out" href="file:///Users/Ray/Downloads/geofence-app_10.html#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">âˆ’</span></a></div></div><div class="leaflet-top leaflet-right"><div class="tile-toggle leaflet-control">
    <select id="tileSelect" onchange="changeMapStyle(this.value)" title="Switch map style">
      <option value="0">ğŸ—º Streets</option><option value="1">ğŸŒ² Outdoors</option><option value="2">ğŸ›° Satellite</option><option value="3">ğŸ›° Hybrid</option><option value="4">â˜ï¸ Light</option><option value="5">ğŸŒ™ Dark</option>
    </select></div></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com/" title="A JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a> <span aria-hidden="true">|</span> Â© <a href="https://www.mapbox.com/">Mapbox</a> Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a></div></div></div></div>
  <div id="drawHint"></div>
  <div id="shareBanner" onclick="copyShareURL()">ğŸ”— Click to copy shareable link with your current zones</div>
</div>

<!-- Google Sheets Modal -->
<div class="modal-overlay" id="sheetsModal">
  <div class="modal">
    <h2>GOOGLE SHEETS INTEGRATION</h2>
    <p>Paste your Spreadsheet ID below. The sheet must be shared: <strong>File â†’ Share â†’ Anyone with link â†’ Viewer</strong>.</p>
    <label>SPREADSHEET ID</label>
    <input type="text" id="sheetId" placeholder="e.g. 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
    <div class="gs-help">From your URL: docs.google.com/spreadsheets/d/<strong>[THIS PART]</strong>/edit</div>
    <label>SHEET TAB NAME</label>
    <input type="text" id="sheetName" value="Sheet1">
    <label>LATITUDE COLUMN</label>
    <input type="text" id="colLat" value="latitude">
    <label>LONGITUDE COLUMN</label>
    <input type="text" id="colLng" value="longitude">
    <label>PROPERTY ID COLUMN (APN)</label>
    <input type="text" id="colAPN" value="APN">
    <label>CITY COLUMN</label>
    <input type="text" id="colCity" value="city">
    <label>STATE COLUMN</label>
    <input type="text" id="colState" value="state">
    <label>ZIP COLUMN</label>
    <input type="text" id="colZip" value="zip">
    <label>OUTPUT ZONE COLUMN NAME</label>
    <input type="text" id="colZone" value="Zone">
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="closeSheetsModal()">CANCEL</button>
      <button class="btn btn-primary" onclick="connectSheets()">CONNECT &amp; LOAD</button>
    </div>
  </div>
</div>

<!-- Zone Name Modal -->
<div class="modal-overlay" id="nameModal">
  <div class="modal">
    <h2>NAME THIS ZONE</h2>
    <p>Give this geofence zone a name. This label will appear in your exported spreadsheet.</p>
    <label>ZONE NAME</label>
    <input type="text" id="polyNameInput" placeholder="e.g. North District, Zone A, Territory 1">
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="closeNameModal()">CANCEL</button>
      <button class="btn btn-primary" onclick="savePolyName()">SAVE ZONE</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS = ['#00e5ff','#ff6b35','#00ff88','#f7c948','#c084fc','#fb7185','#38bdf8','#a3e635'];
let selectedColor = COLORS[0];
let polygons = [];      // {id, name, color, layer, points}
let properties = [];    // loaded from sheet
let sheetConfig = {};
let countyLayer = null;
let editingPolyId = null;
let pendingPts = null, pendingColor = null;

// Drawing
let drawMode = null;
let drawPoints = [];
let drawPolyline = null;
let drawPreview = null;
let rectStart = null;
let isDragging = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', {
  zoomControl: true,
  doubleClickZoom: false,
  scrollWheelZoom: true,
  touchZoom: true,
  dragging: true,
  keyboard: true,
}).setView([39.5, -98.35], 4);
// â”€â”€ MAP TILE LAYERS (Mapbox) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAPBOX_TOKEN = 'pk.eyJ1Ijoic3luZXJneWxhbmRncm91cCIsImEiOiJjbW02MjI5dTEwY2xtMnFuMGs2Y3Y2OWlwIn0.O7gX97oTNFUw9HooOheq6w';
const MAPBOX_ATTR = 'Â© <a href="https://www.mapbox.com/">Mapbox</a> Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a>';

const tileStyles = [
  { id: 'streets-v12',           label: 'ğŸ—º Streets'   },
  { id: 'outdoors-v12',          label: 'ğŸŒ² Outdoors'  },
  { id: 'satellite-v9',          label: 'ğŸ›° Satellite' },
  { id: 'satellite-streets-v12', label: 'ğŸ›° Hybrid'    },
  { id: 'light-v11',             label: 'â˜ï¸ Light'     },
  { id: 'dark-v11',              label: 'ğŸŒ™ Dark'      },
];

function mbUrl(styleId) {
  return `https://api.mapbox.com/styles/v1/mapbox/${styleId}/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`;
}

function makeTileLayer(styleId) {
  return L.tileLayer(mbUrl(styleId), {
    attribution: MAPBOX_ATTR,
    tileSize: 256,
    maxZoom: 22
  });
}

let currentStyleIdx = 0;
let currentTileLayer = makeTileLayer(tileStyles[0].id);
currentTileLayer.addTo(map);

// Map style dropdown control
const tileToggle = L.control({ position: 'topright' });
tileToggle.onAdd = function() {
  const div = L.DomUtil.create('div', 'tile-toggle');
  const options = tileStyles.map((s, i) =>
    `<option value="${i}">${s.label}</option>`
  ).join('');
  div.innerHTML = `
    <select id="tileSelect" onchange="changeMapStyle(this.value)" title="Switch map style">
      ${options}
    </select>`;
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);
  return div;
};
tileToggle.addTo(map);

function changeMapStyle(idx) {
  currentStyleIdx = parseInt(idx);
  const style = tileStyles[currentStyleIdx];
  map.removeLayer(currentTileLayer);
  currentTileLayer = makeTileLayer(style.id);
  currentTileLayer.addTo(map);
  if (countyLayer) countyLayer.bringToFront();
}

// Keep cycleMapStyle for backwards compat
function cycleMapStyle() {
  changeMapStyle((currentStyleIdx + 1) % tileStyles.length);
  document.getElementById('tileSelect').value = currentStyleIdx;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLOR SWATCHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COLORS.forEach(c => {
  const sw = document.createElement('div');
  sw.className = 'color-swatch' + (c === selectedColor ? ' sel' : '');
  sw.style.background = c;
  sw.onclick = () => {
    selectedColor = c;
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('sel'));
    sw.classList.add('sel');
  };
  document.getElementById('colorRow').appendChild(sw);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATES / COUNTIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATES = [["Alabama","AL"],["Alaska","AK"],["Arizona","AZ"],["Arkansas","AR"],["California","CA"],["Colorado","CO"],["Connecticut","CT"],["Delaware","DE"],["Florida","FL"],["Georgia","GA"],["Hawaii","HI"],["Idaho","ID"],["Illinois","IL"],["Indiana","IN"],["Iowa","IA"],["Kansas","KS"],["Kentucky","KY"],["Louisiana","LA"],["Maine","ME"],["Maryland","MD"],["Massachusetts","MA"],["Michigan","MI"],["Minnesota","MN"],["Mississippi","MS"],["Missouri","MO"],["Montana","MT"],["Nebraska","NE"],["Nevada","NV"],["New Hampshire","NH"],["New Jersey","NJ"],["New Mexico","NM"],["New York","NY"],["North Carolina","NC"],["North Dakota","ND"],["Ohio","OH"],["Oklahoma","OK"],["Oregon","OR"],["Pennsylvania","PA"],["Rhode Island","RI"],["South Carolina","SC"],["South Dakota","SD"],["Tennessee","TN"],["Texas","TX"],["Utah","UT"],["Vermont","VT"],["Virginia","VA"],["Washington","WA"],["West Virginia","WV"],["Wisconsin","WI"],["Wyoming","WY"]];
const STATE_FIPS = {"AL":"01","AK":"02","AZ":"04","AR":"05","CA":"06","CO":"08","CT":"09","DE":"10","FL":"12","GA":"13","HI":"15","ID":"16","IL":"17","IN":"18","IA":"19","KS":"20","KY":"21","LA":"22","ME":"23","MD":"24","MA":"25","MI":"26","MN":"27","MS":"28","MO":"29","MT":"30","NE":"31","NV":"32","NH":"33","NJ":"34","NM":"35","NY":"36","NC":"37","ND":"38","OH":"39","OK":"40","OR":"41","PA":"42","RI":"44","SC":"45","SD":"46","TN":"47","TX":"48","UT":"49","VT":"50","VA":"51","WA":"53","WV":"54","WI":"55","WY":"56"};

const stateSelect = document.getElementById('stateSelect');
STATES.forEach(([name, abbr]) => {
  const o = document.createElement('option'); o.value = abbr; o.textContent = name;
  stateSelect.appendChild(o);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTY DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COUNTY_DATA = {};

async function loadCounties() {
  const abbr = stateSelect.value;
  if (!abbr) return;
  const cs = document.getElementById('countySelect');
  cs.innerHTML = '<option value="">Loading counties...</option>';

  function populateDropdown(counties) {
    cs.innerHTML = '<option value="">â€” Select County â€”</option>';
    counties.forEach(name => {
      const o = document.createElement('option'); o.value = name; o.textContent = name + ' County';
      cs.appendChild(o);
    });
    const saved = loadAppState();
    if (saved && saved.state === abbr && saved.county) cs.value = saved.county;
  }

  // 1. Check cache first
  try {
    const cached = localStorage.getItem('counties_' + abbr);
    if (cached) {
      const parsed = JSON.parse(cached);
      if (parsed && parsed.counties && parsed.abbr === abbr &&
          Date.now() - parsed.ts < 30 * 24 * 60 * 60 * 1000) {
        populateDropdown(parsed.counties);
        return;
      } else {
        localStorage.removeItem('counties_' + abbr);
      }
    }
  } catch(e) { localStorage.removeItem('counties_' + abbr); }

  // 2. Fetch from Census API
  try {
    const fips = STATE_FIPS[abbr];
    const r = await fetch(`https://api.census.gov/data/2020/dec/pl?get=NAME&for=county:*&in=state:${fips}`);
    const data = await r.json();
    const stateName = STATES.find(s => s[1] === abbr)[0];
    const counties = data.slice(1).map(row => row[0].replace(`, ${stateName}`, '').replace(/ County$/, '').trim()).sort();
    // Save to cache
    try { localStorage.setItem('counties_' + abbr, JSON.stringify({ counties, abbr, ts: Date.now() })); } catch(e) {}
    populateDropdown(counties);
  } catch(e) {
    // 3. Try stale cache as last resort
    try {
      const stale = localStorage.getItem('counties_' + abbr);
      if (stale) { populateDropdown(JSON.parse(stale).counties); return; }
    } catch(e2) {}
    cs.innerHTML = '<option value="">Failed to load â€” check connection</option>';
  }
}

async function loadCounty() {
  const abbr = stateSelect.value;
  const county = document.getElementById('countySelect').value;
  saveAppState();
  if (!abbr || !county) return;
  if (countyLayer) { map.removeLayer(countyLayer); countyLayer = null; }
  showToast('Loading county boundary...', 'info');
  try {
    const fips = STATE_FIPS[abbr];
    const url = `https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_Current/MapServer/82/query?where=STATE%3D'${fips}'%20AND%20BASENAME%3D'${encodeURIComponent(county)}'&outFields=*&f=geojson`;
    const r = await fetch(url);
    const geojson = await r.json();
    if (geojson.features && geojson.features.length > 0) {
      countyLayer = L.geoJSON(geojson, {
        style: { color:'#6600cc', weight:3, fillColor:'#000000', fillOpacity:0.15 }
      }).addTo(map);
      map.fitBounds(countyLayer.getBounds(), { padding:[30,30] });
      showToast(`${county} County loaded`, 'success');
    } else {
      showToast('County boundary not found', 'error');
    }
  } catch(e) {
    showToast('Could not load county boundary', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDraw(mode) {
  cancelDraw();
  drawMode = mode;
  drawPoints = [];
  map.getContainer().style.cursor = 'crosshair';
  document.getElementById('btnPolygon').classList.toggle('active', mode === 'polygon');
  document.getElementById('btnRectangle').classList.toggle('active', mode === 'rectangle');
  document.getElementById('btnCancel').style.display = 'block';
  const hint = document.getElementById('drawHint');
  hint.style.display = 'block';
  if (mode === 'polygon') {
    hint.textContent = 'ğŸ“ Click to add points â€” Double-click to finish';
    document.getElementById('drawHelp').textContent = 'Click to place points. Double-click to close the shape.';
  } else {
    hint.textContent = 'â¬œ Click and drag to draw a rectangle';
    document.getElementById('drawHelp').textContent = 'Click and drag on the map to draw a rectangular zone.';
  }
}

function cancelDraw() {
  drawMode = null; drawPoints = []; rectStart = null; isDragging = false;
  if (drawPolyline) { map.removeLayer(drawPolyline); drawPolyline = null; }
  if (drawPreview) { map.removeLayer(drawPreview); drawPreview = null; }
  map.getContainer().style.cursor = '';
  document.getElementById('btnPolygon').classList.remove('active');
  document.getElementById('btnRectangle').classList.remove('active');
  document.getElementById('btnCancel').style.display = 'none';
  document.getElementById('drawHint').style.display = 'none';
  document.getElementById('drawHelp').textContent = 'Select a mode above, then draw on the map.';
}

map.on('click', function(e) {
  if (drawMode !== 'polygon') return;
  drawPoints.push(e.latlng);
  if (drawPolyline) map.removeLayer(drawPolyline);
  drawPolyline = L.polyline(drawPoints, { color: selectedColor, weight: 2, dashArray: '5 5' }).addTo(map);
  if (drawPoints.length >= 3) {
    if (drawPreview) map.removeLayer(drawPreview);
    drawPreview = L.polygon(drawPoints, { color: selectedColor, fillColor: selectedColor, fillOpacity: 0.15, weight: 2 }).addTo(map);
  }
});

map.on('dblclick', function(e) {
  if (drawMode !== 'polygon') return;
  L.DomEvent.stop(e);
  if (drawPoints.length < 3) { showToast('Need at least 3 points', 'error'); return; }
  const pts = drawPoints.slice();
  const color = selectedColor;
  cancelDraw();
  openNameModalForNew(pts, color);
});

map.on('mousedown', function(e) {
  if (drawMode !== 'rectangle') return;
  rectStart = e.latlng; isDragging = true;
});

map.on('mousemove', function(e) {
  if (drawMode === 'rectangle' && isDragging && rectStart) {
    if (drawPreview) map.removeLayer(drawPreview);
    drawPreview = L.rectangle(L.latLngBounds(rectStart, e.latlng), {
      color: selectedColor, fillColor: selectedColor, fillOpacity: 0.15, weight: 2
    }).addTo(map);
  }
});

map.on('mouseup', function(e) {
  if (drawMode !== 'rectangle' || !isDragging || !rectStart) return;
  isDragging = false;
  const end = e.latlng;
  if (Math.abs(rectStart.lat - end.lat) < 0.001 && Math.abs(rectStart.lng - end.lng) < 0.001) { rectStart = null; if (drawPreview) { map.removeLayer(drawPreview); drawPreview = null; } return; }
  const bounds = L.latLngBounds(rectStart, end);
  const ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
  const pts = [L.latLng(ne.lat, sw.lng), L.latLng(ne.lat, ne.lng), L.latLng(sw.lat, ne.lng), L.latLng(sw.lat, sw.lng)];
  const color = selectedColor;
  if (drawPreview) { map.removeLayer(drawPreview); drawPreview = null; }
  cancelDraw();
  openNameModalForNew(pts, color);
  rectStart = null;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAME MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNameModalForNew(pts, color) {
  pendingPts = pts; pendingColor = color; editingPolyId = null;
  document.getElementById('polyNameInput').value = '';
  document.getElementById('nameModal').classList.add('open');
  setTimeout(() => document.getElementById('polyNameInput').focus(), 100);
}

function openNameModal(polyId) {
  editingPolyId = polyId; pendingPts = null;
  const p = polygons.find(p => p.id === polyId);
  document.getElementById('polyNameInput').value = p ? p.name : '';
  document.getElementById('nameModal').classList.add('open');
  setTimeout(() => document.getElementById('polyNameInput').focus(), 100);
}

function closeNameModal() {
  document.getElementById('nameModal').classList.remove('open');
  pendingPts = null; editingPolyId = null;
}

function savePolyName() {
  const name = document.getElementById('polyNameInput').value.trim();
  if (!name) { showToast('Please enter a zone name', 'error'); return; }

  if (editingPolyId) {
    const p = polygons.find(p => p.id === editingPolyId);
    if (p) { p.name = name; p.layer.unbindTooltip(); p.layer.bindTooltip(name, { permanent:true, direction:'center', className:'poly-tooltip' }); }
  } else if (pendingPts) {
    addPolygonToMap({ id: 'poly_' + Date.now(), name, color: pendingColor, points: pendingPts.map(ll => [ll.lat, ll.lng]) });
  }

  closeNameModal();
  renderPolygonList();
  persistZones();
  showToast(`Zone "${name}" saved`, 'success');
}

document.getElementById('polyNameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') savePolyName();
  if (e.key === 'Escape') closeNameModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD POLYGON TO MAP (used by draw + load)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPolygonToMap(data) {
  const { id, name, color, points } = data;
  const latlngs = points.map(p => L.latLng(p[0], p[1]));
  const layer = L.polygon(latlngs, { color, fillColor: color, fillOpacity: 0.2, weight: 2 }).addTo(map);
  layer.bindTooltip(name, { permanent: true, direction: 'center', className: 'poly-tooltip' });
  layer.on('click', () => openNameModal(id));
  polygons.push({ id, name, color, layer, points });
  return layer;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLYGON LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPolygonList() {
  document.getElementById('zoneCount').textContent = polygons.length;
  document.getElementById('statPolygons').textContent = polygons.length;
  const list = document.getElementById('polygonsList');
  if (!polygons.length) {
    list.innerHTML = '<div class="empty-state">No zones yet.<br>Draw on the map or load<br>a saved zones file.</div>';
    return;
  }
  list.innerHTML = '';
  polygons.forEach(p => {
    const div = document.createElement('div');
    div.className = 'polygon-item';
    div.innerHTML = `
      <div class="poly-color" style="background:${p.color}"></div>
      <div class="poly-info">
        <div class="poly-name">${p.name}</div>
        <div class="poly-count">${p.propCount !== undefined ? p.propCount + ' properties' : 'not yet assigned'}</div>
      </div>
      <button class="poly-btn" title="Rename" onclick="openNameModal('${p.id}');event.stopPropagation()">âœ</button>
      <button class="poly-btn" title="Delete" onclick="deletePoly('${p.id}');event.stopPropagation()">âœ•</button>
    `;
    div.onclick = () => { try { map.fitBounds(p.layer.getBounds(), { padding:[40,40] }); } catch(e) {} };
    list.appendChild(div);
  });
}

function deletePoly(id) {
  const i = polygons.findIndex(p => p.id === id);
  if (i === -1) return;
  map.removeLayer(polygons[i].layer);
  polygons.splice(i, 1);
  renderPolygonList();
  persistZones();
}

function clearAllZones() {
  if (!polygons.length) return;
  if (!confirm('Delete all zones? This cannot be undone.')) return;
  polygons.forEach(p => map.removeLayer(p.layer));
  polygons = [];
  renderPolygonList();
  persistZones();
  showToast('All zones cleared', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 1: PERSIST ZONES TO LOCALSTORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function persistZones() {
  try {
    const data = polygons.map(p => ({ id: p.id, name: p.name, color: p.color, points: p.points }));
    localStorage.setItem('geofence_zones', JSON.stringify(data));
  } catch(e) {}
}

function restoreZones() {
  try {
    const raw = localStorage.getItem('geofence_zones');
    if (!raw) return;
    const data = JSON.parse(raw);
    data.forEach(d => addPolygonToMap(d));
    renderPolygonList();
    if (data.length) showToast(`Restored ${data.length} saved zone${data.length > 1 ? 's' : ''}`, 'success');
  } catch(e) {}
}

function saveAppState() {
  try {
    localStorage.setItem('geofence_app_state', JSON.stringify({
      state: stateSelect.value,
      county: document.getElementById('countySelect').value
    }));
  } catch(e) {}
}

function loadAppState() {
  try { return JSON.parse(localStorage.getItem('geofence_app_state')); } catch(e) { return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 4: SAVE / LOAD ZONES FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveZonesFile() {
  if (!polygons.length) { showToast('No zones to save', 'error'); return; }
  const data = { version: 1, saved: new Date().toISOString(), zones: polygons.map(p => ({ id: p.id, name: p.name, color: p.color, points: p.points })) };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `geofence-zones-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showToast('Zones file downloaded!', 'success');
}

function loadZonesFile() {
  document.getElementById('zoneFileInput').click();
}

function importZonesFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      const zones = data.zones || data; // support both wrapped and raw array
      if (!Array.isArray(zones)) throw new Error('Invalid format');
      // Clear existing
      polygons.forEach(p => map.removeLayer(p.layer));
      polygons = [];
      zones.forEach(d => addPolygonToMap(d));
      renderPolygonList();
      persistZones();
      showToast(`Loaded ${zones.length} zone${zones.length !== 1 ? 's' : ''} from file`, 'success');
      // Zoom to fit all zones
      if (polygons.length) {
        const group = L.featureGroup(polygons.map(p => p.layer));
        map.fitBounds(group.getBounds(), { padding:[40,40] });
      }
    } catch(err) {
      showToast('Could not read zones file â€” make sure it was saved by this app', 'error');
    }
    e.target.value = '';
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 2: SHARE URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shareURL() {
  if (!polygons.length) { showToast('Draw some zones first to share them', 'error'); return; }
  const data = polygons.map(p => ({ id: p.id, name: p.name, color: p.color, points: p.points }));
  const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
  const url = window.location.origin + window.location.pathname + '?zones=' + encoded;
  if (url.length > 8000) {
    showToast('Too many zones to encode in a URL â€” use Save Zones file instead', 'error');
    return;
  }
  navigator.clipboard.writeText(url).then(() => {
    showToast('Share link copied to clipboard!', 'success');
  }).catch(() => {
    // fallback: show banner with URL
    const banner = document.getElementById('shareBanner');
    banner.textContent = 'ğŸ”— ' + url;
    banner.style.display = 'block';
    setTimeout(() => banner.style.display = 'none', 8000);
  });
}

function copyShareURL() {
  const banner = document.getElementById('shareBanner');
  navigator.clipboard.writeText(banner.textContent.replace('ğŸ”— ', '')).then(() => {
    showToast('Copied!', 'success');
    banner.style.display = 'none';
  });
}

function loadZonesFromURL() {
  try {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('zones');
    if (!encoded) return false;
    const data = JSON.parse(decodeURIComponent(atob(encoded)));
    data.forEach(d => addPolygonToMap(d));
    renderPolygonList();
    if (polygons.length) {
      const group = L.featureGroup(polygons.map(p => p.layer));
      map.fitBounds(group.getBounds(), { padding:[40,40] });
      showToast(`Loaded ${polygons.length} shared zone${polygons.length !== 1 ? 's' : ''}`, 'success');
    }
    return true;
  } catch(e) { return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURE 3: MOBILE SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// Close sidebar on map click (mobile)
map.on('click', () => {
  if (window.innerWidth <= 700) document.getElementById('sidebar').classList.remove('open');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSheetsModal() { document.getElementById('sheetsModal').classList.add('open'); }
function closeSheetsModal() { document.getElementById('sheetsModal').classList.remove('open'); }

async function connectSheets() {
  const sheetId = document.getElementById('sheetId').value.trim();
  if (!sheetId) { showToast('Please enter a Spreadsheet ID', 'error'); return; }
  sheetConfig = {
    sheetId,
    sheetName: document.getElementById('sheetName').value.trim() || 'Sheet1',
    colLat: document.getElementById('colLat').value.trim() || 'latitude',
    colLng: document.getElementById('colLng').value.trim() || 'longitude',
    colAPN: document.getElementById('colAPN').value.trim() || 'APN',
    colCity: document.getElementById('colCity').value.trim() || 'city',
    colState: document.getElementById('colState').value.trim() || 'state',
    colZip: document.getElementById('colZip').value.trim() || 'zip',
    colZone: document.getElementById('colZone').value.trim() || 'Zone'
  };
  // Save config for next session
  try { localStorage.setItem('geofence_sheet_config', JSON.stringify(sheetConfig)); } catch(e) {}

  showToast('Connecting to Google Sheets...', 'info');
  const url = `https://docs.google.com/spreadsheets/d/${sheetConfig.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetConfig.sheetName)}`;
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const csv = await r.text();
    parseAndLoad(csv);
    setConnected(true);
    closeSheetsModal();
  } catch(e) {
    showToast('Connection failed. Make sure sharing is set to Anyone with link â†’ Viewer', 'error');
  }
}

function parseAndLoad(csv) {
  const rows = parseCSV(csv);
  if (rows.length < 2) { showToast('Sheet appears empty', 'error'); return; }
  const headers = rows[0];
  const { colLat, colLng, colAPN, colCity, colState, colZip } = sheetConfig;

  const idx = name => headers.indexOf(name);
  const latIdx = idx(colLat), lngIdx = idx(colLng);
  if (latIdx === -1 || lngIdx === -1) {
    showToast(`Columns "${colLat}" or "${colLng}" not found. Check âš™ Sheets settings.`, 'error');
    return;
  }

  properties.forEach(p => { if (p.marker) map.removeLayer(p.marker); });
  properties = [];
  let loaded = 0;

  rows.slice(1).forEach((row, i) => {
    const lat = parseFloat(row[latIdx]), lng = parseFloat(row[lngIdx]);
    if (isNaN(lat) || isNaN(lng)) return;

    const apn  = idx(colAPN)   !== -1 ? row[idx(colAPN)]   : `Row ${i+2}`;
    const city = idx(colCity)  !== -1 ? row[idx(colCity)]  : '';
    const st   = idx(colState) !== -1 ? row[idx(colState)] : '';
    const zip  = idx(colZip)   !== -1 ? row[idx(colZip)]   : '';
    const location = [city, st, zip].filter(Boolean).join(', ');

    const popup = `<div style="font-family:'Space Mono',monospace;font-size:12px;line-height:1.9">
      <strong style="color:#00e5ff">APN: ${apn}</strong><br>
      ${location ? `<span style="color:#e8f0fe">${location}</span><br>` : ''}
      <span style="color:#6b7a99;font-size:10px">${lat.toFixed(5)}, ${lng.toFixed(5)}</span>
    </div>`;

    const marker = L.circleMarker([lat, lng], {
      radius: 5, color: '#f7c948', fillColor: '#f7c948', fillOpacity: 0.85, weight: 1
    }).addTo(map).bindPopup(popup);

    properties.push({ row, headers, lat, lng, apn, city, state: st, zip, marker, zone: null });
    loaded++;
  });

  document.getElementById('statProps').textContent = loaded;
  showToast(`Loaded ${loaded} properties from sheet`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE ASSIGNMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pointInPolygon(lat, lng, layer) {
  try {
    let rings = layer.getLatLngs();
    if (Array.isArray(rings[0]) || (rings[0] && rings[0][0] && rings[0][0].lat !== undefined)) rings = rings[0];
    const x = lng, y = lat;
    let inside = false;
    for (let i = 0, j = rings.length - 1; i < rings.length; j = i++) {
      const xi = rings[i].lng, yi = rings[i].lat, xj = rings[j].lng, yj = rings[j].lat;
      if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) inside = !inside;
    }
    return inside;
  } catch(e) { return false; }
}

function runAssignment() {
  if (!polygons.length) { showToast('Draw at least one zone first', 'error'); return; }
  if (!properties.length) { showToast('No properties loaded. Connect Google Sheets first.', 'error'); return; }
  polygons.forEach(p => p.propCount = 0);
  let assigned = 0;
  properties.forEach(prop => {
    prop.zone = null;
    for (const poly of polygons) {
      if (pointInPolygon(prop.lat, prop.lng, poly.layer)) {
        prop.zone = poly.name; poly.propCount++;
        prop.marker.setStyle({ color: poly.color, fillColor: poly.color });
        assigned++; break;
      }
    }
    if (!prop.zone) prop.marker.setStyle({ color: '#f7c948', fillColor: '#f7c948' });
  });
  document.getElementById('statAssigned').textContent = assigned;
  renderPolygonList();
  showToast(`${assigned} of ${properties.length} properties assigned`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (!properties.length) { showToast('No properties to export', 'error'); return; }
  const zoneCol = sheetConfig.colZone || 'Zone';
  const headers = [...properties[0].headers];
  if (!headers.includes(zoneCol)) headers.push(zoneCol);
  const zi = headers.indexOf(zoneCol);
  const rows = [headers.map(ce).join(',')];
  properties.forEach(prop => {
    const row = [...prop.row];
    while (row.length < headers.length) row.push('');
    row[zi] = prop.zone || '';
    rows.push(row.map(ce).join(','));
  });
  const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'properties_with_zones.csv'; a.click();
  showToast('CSV downloaded! Import it back into your Google Sheet.', 'success');
}

function ce(v) {
  if (v == null) return '';
  const s = String(v);
  return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
}

function parseCSV(text) {
  const rows = [];
  text.split('\n').forEach(line => {
    if (!line.trim()) return;
    const row = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      if (line[i] === '"') { if (inQ && line[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
      else if (line[i] === ',' && !inQ) { row.push(cur.trim()); cur = ''; }
      else cur += line[i];
    }
    row.push(cur.trim()); rows.push(row);
  });
  return rows;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setConnected(v) {
  document.getElementById('statusDot').className = 'status-dot' + (v ? ' on' : '');
  document.getElementById('statusText').textContent = v ? 'SHEET CONNECTED' : 'NOT CONNECTED';
}

let toastTimer;
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type + ' show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 4500);
}

document.getElementById('sheetsModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeSheetsModal(); });
document.getElementById('nameModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeNameModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” restore saved state on load
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  // Try URL zones first (shared link)
  const fromURL = loadZonesFromURL();

  // If no URL zones, restore from localStorage
  if (!fromURL) restoreZones();

  // Restore sheet config
  try {
    const savedConfig = JSON.parse(localStorage.getItem('geofence_sheet_config'));
    if (savedConfig) {
      sheetConfig = savedConfig;
      document.getElementById('sheetId').value = savedConfig.sheetId || '';
      document.getElementById('sheetName').value = savedConfig.sheetName || 'Sheet1';
      document.getElementById('colLat').value = savedConfig.colLat || 'latitude';
      document.getElementById('colLng').value = savedConfig.colLng || 'longitude';
      document.getElementById('colAPN').value = savedConfig.colAPN || 'APN';
      document.getElementById('colCity').value = savedConfig.colCity || 'city';
      document.getElementById('colState').value = savedConfig.colState || 'state';
      document.getElementById('colZip').value = savedConfig.colZip || 'zip';
      document.getElementById('colZone').value = savedConfig.colZone || 'Zone';
    }
  } catch(e) {}

  // Restore last selected state/county
  const appState = loadAppState();
  if (appState && appState.state) {
    stateSelect.value = appState.state;
    loadCounties().then(() => {
      if (appState.county) {
        document.getElementById('countySelect').value = appState.county;
      }
    });
  }
})();

  // Expose functions to global scope for HTML onchange/onclick handlers
  window.loadCounties = loadCounties;
  window.loadCounty = loadCounty;
  window.startDraw = startDraw;
  window.cancelDraw = cancelDraw;
  window.savePolyName = savePolyName;
  window.closeNameModal = closeNameModal;
  window.openNameModal = openNameModal;
  window.openSheetsModal = openSheetsModal;
  window.closeSheetsModal = closeSheetsModal;
  window.connectSheets = connectSheets;
  window.runAssignment = runAssignment;
  window.exportCSV = exportCSV;
  window.saveZonesFile = saveZonesFile;
  window.loadZonesFile = loadZonesFile;
  window.importZonesFile = importZonesFile;
  window.shareURL = shareURL;
  window.copyShareURL = copyShareURL;
  window.toggleSidebar = toggleSidebar;
  window.changeMapStyle = changeMapStyle;
  window.cycleMapStyle = cycleMapStyle;
  window.deletePoly = deletePoly;
  window.clearAllZones = clearAllZones;

}); // end DOMContentLoaded
</script>


</body></html>