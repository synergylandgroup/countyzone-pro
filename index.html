<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CountyZone Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<style>
  :root {
    --bg:#0a0f1a; --panel:#111827; --panel2:#1a2235; --border:#1e2d45;
    --accent:#00e5ff; --accent2:#ff6b35; --green:#00ff88; --yellow:#f7c948;
    --text:#e8f0fe; --muted:#6b7a99; --font:'DM Sans',sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:var(--font);height:100vh;display:grid;grid-template-rows:56px 1fr;grid-template-columns:320px 1fr;overflow:hidden;}

  /* HEADER */
  header{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:10px;flex-wrap:nowrap;overflow:hidden;}
  .logo{font-family:var(--font);font-size:14px;font-weight:700;letter-spacing:0.06em;color:var(--accent);white-space:nowrap;}
  .logo span{color:var(--accent2);}
  .hdiv{width:1px;height:22px;background:var(--border);flex-shrink:0;}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);transition:background 0.3s;flex-shrink:0;}
  .status-dot.on{background:var(--green);box-shadow:0 0 8px var(--green);}
  .status-text{font-size:11px;color:var(--muted);font-family:var(--font);white-space:nowrap;}
  .header-actions{margin-left:auto;display:flex;gap:6px;flex-shrink:0;}

  /* BUTTONS */
  .btn{padding:6px 11px;border-radius:6px;border:none;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;letter-spacing:0.04em;transition:all 0.15s;white-space:nowrap;}
  .btn-primary{background:var(--accent);color:#000;}
  .btn-primary:hover{background:#33eaff;transform:translateY(-1px);}
  .btn-secondary{background:transparent;color:var(--accent);border:1px solid var(--accent);}
  .btn-secondary:hover{background:rgba(0,229,255,0.08);}
  .btn-warning{background:transparent;color:var(--yellow);border:1px solid var(--yellow);}
  .btn-warning:hover{background:rgba(247,201,72,0.08);}
  .btn-danger{background:transparent;color:var(--accent2);border:1px solid var(--accent2);}
  .btn-danger:hover{background:rgba(255,107,53,0.08);}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
  .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}

  /* SIDEBAR */
  aside{background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:transform 0.3s;}
  .sidebar-section{padding:13px 15px;border-bottom:1px solid var(--border);flex-shrink:0;}
  .section-label{font-family:var(--font);font-size:10px;font-weight:700;letter-spacing:0.12em;color:var(--muted);text-transform:uppercase;margin-bottom:8px;}
  select,input[type="text"],textarea{width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:6px;font-family:var(--font);font-size:13px;outline:none;transition:border-color 0.15s;margin-bottom:6px;}
  select:focus,input:focus,textarea:focus{border-color:var(--accent);}
  select option{background:#1a2235;}

  /* STATS BAR */
  .stats-bar{display:flex;flex-shrink:0;}
  .stat{flex:1;padding:8px 3px;border-right:1px solid var(--border);text-align:center;}
  .stat:last-child{border-right:none;}
  .stat-val{font-family:var(--font);font-size:15px;font-weight:700;color:var(--accent);}
  .stat-label{font-size:8px;color:var(--muted);letter-spacing:0.06em;text-transform:uppercase;}

  /* COLOR SWATCHES */
  .color-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:6px;}
  .color-swatch{width:26px;height:26px;border-radius:6px;cursor:pointer;border:3px solid transparent;transition:all 0.12s;flex-shrink:0;}
  .color-swatch:hover{transform:scale(1.15);}
  .color-swatch.sel{border-color:#fff;box-shadow:0 0 0 1px rgba(255,255,255,0.5);}

  /* DRAW BUTTONS */
  .draw-btn{width:100%;margin-bottom:5px;padding:8px 11px;background:var(--panel2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px;transition:all 0.15s;}
  .draw-btn:hover{border-color:var(--accent);color:var(--accent);}
  .draw-btn.active{border-color:var(--accent);background:var(--accent);color:#000;}
  .cancel-btn{width:100%;padding:7px 11px;background:transparent;border:1px solid var(--accent2);color:var(--accent2);border-radius:6px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;display:none;transition:all 0.15s;}
  .cancel-btn:hover{background:rgba(255,107,53,0.1);}
  .help-tip{font-size:11px;color:var(--muted);font-family:var(--font);line-height:1.6;margin-top:5px;}
  .zone-file-row{display:flex;gap:6px;margin-top:8px;}
  .zone-file-row .btn{flex:1;text-align:center;font-size:10px;padding:6px 4px;}

  /* POLYGON LIST */
  .polygons-list{flex:1;overflow-y:auto;padding:9px;}
  .polygon-item{background:var(--panel2);border:1px solid var(--border);border-radius:7px;padding:8px 10px;margin-bottom:5px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:border-color 0.15s;}
  .polygon-item:hover{border-color:var(--accent);}
  .poly-info{flex:1;min-width:0;}
  .poly-name{font-size:12px;font-weight:700;color:var(--accent);letter-spacing:0.05em;}
  .poly-count{font-size:10px;color:var(--muted);}
  .poly-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:2px 4px;border-radius:3px;transition:color 0.12s;}
  .poly-btn:hover{color:var(--accent2);}
  .empty-state{text-align:center;color:var(--muted);font-size:12px;padding:24px 10px;line-height:1.8;}

  /* State â†’ County hierarchy */
  .state-group{margin-bottom:5px;}
  .state-header{background:var(--panel2);border:1px solid var(--border);border-radius:7px;padding:8px 11px;cursor:pointer;display:flex;align-items:center;gap:7px;font-weight:700;font-size:12px;transition:border-color 0.15s;user-select:none;}
  .state-header:hover{border-color:var(--accent);color:var(--accent);}
  .state-header .sg-arrow{font-size:9px;color:var(--muted);transition:transform 0.2s;display:inline-block;}
  .state-header.open .sg-arrow{transform:rotate(90deg);}
  .state-counties{display:none;padding-left:8px;margin-top:3px;}
  .state-counties.open{display:block;}
  .county-group{margin-bottom:4px;}
  .county-header{padding:6px 8px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:var(--muted);border-left:2px solid var(--border);margin-left:4px;transition:color 0.15s,border-color 0.15s;user-select:none;border-radius:0 4px 4px 0;}
  .county-header:hover{color:var(--text);border-left-color:var(--accent);background:rgba(0,229,255,0.04);}
  .county-polys{padding-left:10px;}

  /* MAP */
  .map-wrap{position:relative;overflow:hidden;}
  #map{width:100%;height:100%;}
  #drawHint{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(10,15,26,0.92);border:1px solid var(--accent);color:var(--accent);font-family:var(--font);font-size:12px;padding:10px 18px;border-radius:8px;z-index:10;display:none;pointer-events:none;white-space:nowrap;}
  #mapControls{position:absolute;top:10px;right:10px;z-index:10;display:flex;gap:6px;align-items:center;}
  #styleSelect{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;outline:none;color:var(--text);min-width:120px;box-shadow:0 2px 8px rgba(0,0,0,0.5);margin-bottom:0;width:auto;}
  #styleSelect:hover{border-color:var(--accent);}
  #styleSelect option{background:#1a2235;}
  #northBtn{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.5);white-space:nowrap;transition:all 0.15s;opacity:0.6;}
  #northBtn:hover{border-color:var(--accent);color:var(--accent);opacity:1;}
  #sidebarToggle{display:none;background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 10px;font-size:16px;cursor:pointer;}
  #shareBanner{position:absolute;top:12px;left:50%;transform:translateX(-50%);background:rgba(10,15,26,0.95);border:1px solid var(--green);color:var(--green);font-family:var(--font);font-size:11px;padding:10px 16px;border-radius:8px;z-index:10;display:none;max-width:90%;text-align:center;cursor:pointer;}

  /* Zone label on map */
  .zone-label{background:rgba(10,15,26,0.88);border:1px solid #1e2d45;color:#e8f0fe;font-family:var(--font);font-size:11px;padding:4px 9px;border-radius:5px;pointer-events:none;white-space:nowrap;text-align:center;line-height:1.4;}
  .zone-label .zl-letter{font-size:14px;font-weight:700;color:var(--accent);display:block;}
  .zone-label .zl-name{font-size:10px;display:block;opacity:0.85;}

  /* MODALS */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.72);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity 0.2s;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:24px;width:440px;max-width:95vw;max-height:90vh;overflow-y:auto;transform:translateY(10px);transition:transform 0.2s;}
  .modal-overlay.open .modal{transform:translateY(0);}
  .modal h2{font-family:var(--font);font-size:13px;font-weight:700;color:var(--accent);margin-bottom:5px;letter-spacing:0.05em;}
  .modal p{font-size:13px;color:var(--muted);margin-bottom:14px;line-height:1.6;}
  .modal label{font-size:11px;color:var(--muted);font-family:var(--font);display:block;margin-bottom:4px;margin-top:10px;}
  .modal-actions{display:flex;gap:10px;margin-top:16px;justify-content:flex-end;flex-wrap:wrap;}
  .gs-help{font-size:11px;color:var(--muted);margin-top:3px;line-height:1.5;}
  #zoneDescModal textarea{resize:vertical;min-height:80px;margin-bottom:0;}

  /* TOAST */
  .toast{position:fixed;bottom:22px;right:22px;background:var(--panel);border:1px solid var(--border);border-left:3px solid var(--accent);padding:11px 16px;border-radius:8px;font-size:12px;font-family:var(--font);z-index:9999;transform:translateX(120%);transition:transform 0.3s;max-width:320px;line-height:1.5;}
  .toast.show{transform:translateX(0);}
  .toast.error{border-left-color:var(--accent2);}
  .toast.success{border-left-color:var(--green);}

  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .mapboxgl-ctrl-attrib{font-size:10px!important;}
  .mapboxgl-popup-content{padding:0!important;background:transparent!important;box-shadow:none!important;}
  .mapboxgl-popup-tip{display:none!important;}

  @media(max-width:700px){
    body{grid-template-columns:1fr;}
    aside{position:absolute;top:56px;left:0;height:calc(100vh - 56px);width:300px;z-index:500;transform:translateX(-100%);}
    aside.open{transform:translateX(0);}
    .map-wrap{grid-column:1;}
    #sidebarToggle{display:block;}
    .status-text{display:none;}
  }
</style>
</head>
<body>

<header>
  <button id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">â˜°</button>
  <div class="logo">COUNTY<span>ZONE</span> PRO</div>
  <div class="hdiv"></div>
  <div class="status-dot" id="statusDot"></div>
  <div class="status-text" id="statusText">NOT CONNECTED</div>
  <div class="header-actions">
    <button class="btn btn-ghost" onclick="shareURL()" title="Copy shareable link">ğŸ”— Share</button>
    <button class="btn btn-secondary" onclick="openSheetsModal()">âš™ Sheets</button>
    <button class="btn btn-primary" onclick="runAssignment()">â–¶ Assign</button>
    <button class="btn btn-danger" onclick="exportCSV()">â†“ CSV</button>
  </div>
</header>

<aside id="sidebar">
  <div class="sidebar-section">
    <div class="section-label">Location</div>
    <select id="stateSelect" onchange="loadCounties()"><option value="">â€” Select State â€”</option></select>
    <select id="countySelect" onchange="loadCounty()"><option value="">â€” Select County â€”</option></select>
  </div>

  <div class="stats-bar" style="border-bottom:1px solid var(--border)">
    <div class="stat"><div class="stat-val" id="statStates">0</div><div class="stat-label">States</div></div>
    <div class="stat"><div class="stat-val" id="statPolygons">0</div><div class="stat-label">Zones</div></div>
    <div class="stat"><div class="stat-val" id="statProps">0</div><div class="stat-label">Props</div></div>
    <div class="stat"><div class="stat-val" id="statAssigned">0</div><div class="stat-label">Assigned</div></div>
  </div>

  <div class="sidebar-section">
    <div class="section-label">Create Zones</div>
    <button class="draw-btn" id="btnPolygon" onclick="startDraw('polygon')"><span style="font-size:14px">â¬¡</span> Draw Polygon</button>
    <button class="cancel-btn" id="btnCancel" onclick="cancelDraw()">âœ• Cancel Drawing</button>
    <div class="help-tip" id="drawHelp">Select a state &amp; county above, then click Draw Polygon.</div>
    <div class="section-label" style="margin-top:10px">Zone Color</div>
    <div class="color-row" id="colorRow"></div>
    <div class="zone-file-row">
      <button class="btn btn-warning" onclick="saveZonesFile()">ğŸ’¾ Save Zones</button>
      <button class="btn btn-ghost" onclick="loadZonesFile()">ğŸ“‚ Load Zones</button>
    </div>
    <input type="file" id="zoneFileInput" accept=".json" style="display:none" onchange="importZonesFile(event)">
  </div>

  <div style="padding:9px 14px 0;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0;">
    <span class="section-label" style="margin:0">Saved Zones</span>
    <span style="background:rgba(0,229,255,0.1);color:var(--accent);font-family:var(--font);font-size:10px;padding:2px 7px;border-radius:4px" id="zoneCount">0</span>
    <button class="btn btn-ghost" style="margin-left:auto;font-size:10px;padding:3px 7px" onclick="clearAllZones()">Clear All</button>
  </div>
  <div class="polygons-list" id="polygonsList">
    <div class="empty-state">No zones yet.<br>Select a state &amp; county,<br>then draw on the map.</div>
  </div>
</aside>

<div class="map-wrap">
  <div id="map"></div>
  <div id="mapControls">
    <button id="northBtn" onclick="resetNorth()" title="Reset to North">â¬† North</button>
    <select id="styleSelect" onchange="changeMapStyle(this.value)" title="Switch map style"></select>
  </div>
  <div id="drawHint"></div>
  <div id="shareBanner" onclick="copyShareURL()">ğŸ”— Click to copy shareable link with your current zones</div>
</div>

<!-- Google Sheets Modal -->
<div class="modal-overlay" id="sheetsModal">
  <div class="modal">
    <h2>GOOGLE SHEETS INTEGRATION</h2>
    <p>Paste your Spreadsheet ID below. The sheet must be shared: <strong>File â†’ Share â†’ Anyone with link â†’ Viewer</strong>.</p>
    <label>SPREADSHEET ID</label>
    <input type="text" id="sheetId" placeholder="e.g. 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
    <div class="gs-help">From your URL: docs.google.com/spreadsheets/d/<strong>[THIS PART]</strong>/edit</div>
    <label>SHEET TAB NAME</label><input type="text" id="sheetName" value="Sheet1">
    <label>LATITUDE COLUMN</label><input type="text" id="colLat" value="latitude">
    <label>LONGITUDE COLUMN</label><input type="text" id="colLng" value="longitude">
    <label>PROPERTY ID COLUMN (APN)</label><input type="text" id="colAPN" value="APN">
    <label>CITY COLUMN</label><input type="text" id="colCity" value="city">
    <label>STATE COLUMN</label><input type="text" id="colState" value="state">
    <label>ZIP COLUMN</label><input type="text" id="colZip" value="zip">
    <label>OUTPUT ZONE COLUMN NAME</label><input type="text" id="colZone" value="Zone">
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="closeSheetsModal()">CANCEL</button>
      <button class="btn btn-primary" onclick="connectSheets()">CONNECT &amp; LOAD</button>
    </div>
  </div>
</div>

<!-- Zone Notes Modal -->
<div class="modal-overlay" id="zoneDescModal">
  <div class="modal">
    <h2 id="zoneDescTitle">ZONE INFO</h2>
    <p id="zoneDescSubtitle" style="margin-bottom:8px;font-size:12px"></p>
    <label>PRICING ZONE NOTES</label>
    <textarea id="zoneDescInput" placeholder="Enter custom notes or pricing zone description..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeZoneDescModal()">CANCEL</button>
      <button class="btn btn-primary" onclick="saveZoneDesc()">SAVE NOTES</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATES DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATES = [["Alabama","AL"],["Alaska","AK"],["Arizona","AZ"],["Arkansas","AR"],["California","CA"],["Colorado","CO"],["Connecticut","CT"],["Delaware","DE"],["Florida","FL"],["Georgia","GA"],["Hawaii","HI"],["Idaho","ID"],["Illinois","IL"],["Indiana","IN"],["Iowa","IA"],["Kansas","KS"],["Kentucky","KY"],["Louisiana","LA"],["Maine","ME"],["Maryland","MD"],["Massachusetts","MA"],["Michigan","MI"],["Minnesota","MN"],["Mississippi","MS"],["Missouri","MO"],["Montana","MT"],["Nebraska","NE"],["Nevada","NV"],["New Hampshire","NH"],["New Jersey","NJ"],["New Mexico","NM"],["New York","NY"],["North Carolina","NC"],["North Dakota","ND"],["Ohio","OH"],["Oklahoma","OK"],["Oregon","OR"],["Pennsylvania","PA"],["Rhode Island","RI"],["South Carolina","SC"],["South Dakota","SD"],["Tennessee","TN"],["Texas","TX"],["Utah","UT"],["Vermont","VT"],["Virginia","VA"],["Washington","WA"],["West Virginia","WV"],["Wisconsin","WI"],["Wyoming","WY"]];
const STATE_FIPS = {"AL":"01","AK":"02","AZ":"04","AR":"05","CA":"06","CO":"08","CT":"09","DE":"10","FL":"12","GA":"13","HI":"15","ID":"16","IL":"17","IN":"18","IA":"19","KS":"20","KY":"21","LA":"22","ME":"23","MD":"24","MA":"25","MI":"26","MN":"27","MS":"28","MO":"29","MT":"30","NE":"31","NV":"32","NH":"33","NJ":"34","NM":"35","NY":"36","NC":"37","ND":"38","OH":"39","OK":"40","OR":"41","PA":"42","RI":"44","SC":"45","SD":"46","TN":"47","TX":"48","UT":"49","VT":"50","VA":"51","WA":"53","WV":"54","WI":"55","WY":"56"};

function abbrToFullName(abbr) {
  const s = STATES.find(s => s[1] === abbr);
  return s ? s[0] : abbr;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAPBOX_TOKEN = 'pk.eyJ1Ijoic3luZXJneWxhbmRncm91cCIsImEiOiJjbW02MjI5dTEwY2xtMnFuMGs2Y3Y2OWlwIn0.O7gX97oTNFUw9HooOheq6w';
mapboxgl.accessToken = MAPBOX_TOKEN;

// 8 distinct zone colors
const COLORS = ['#00e5ff','#ff6b35','#00ff88','#f7c948','#c084fc','#fb7185','#38bdf8','#a3e635'];
let selectedColor = COLORS[0];

// polygons: { id, name, letter, stateAbbr, countyName, color, points, description, labelMarker, handles[], _isRect, _bounds }
let polygons = [];
let properties = [];
let sheetConfig = {};
let countySourceId = null;
let _pendingCountyGeoJSON = null;

// Draw state
let drawMode = null;
let polyState = 'idle';
let drawPoints = [];

// Zone desc modal
let _editingDescId = null;

// Mapbox draw layer IDs
const SRC_FILL    = '__draw_fill';
const SRC_LINE    = '__draw_line';
const SRC_PREVIEW = '__draw_preview';
const SRC_VERTS   = '__draw_verts';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD COLOR SWATCHES â€” runs immediately on parse
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function buildSwatches() {
  const row = document.getElementById('colorRow');
  COLORS.forEach((c, i) => {
    const s = document.createElement('div');
    s.className = 'color-swatch' + (i === 0 ? ' sel' : '');
    s.style.background = c;
    s.title = c;
    s.onclick = () => {
      document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('sel'));
      s.classList.add('sel');
      selectedColor = c;
    };
    row.appendChild(s);
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP STYLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAP_STYLES = [
  { id: 'mapbox://styles/mapbox/streets-v12',           label: 'ğŸ—º Streets'  },
  { id: 'mapbox://styles/mapbox/outdoors-v12',          label: 'ğŸŒ² Outdoors' },
  { id: 'mapbox://styles/mapbox/satellite-v9',          label: 'ğŸ›° Satellite'},
  { id: 'mapbox://styles/mapbox/satellite-streets-v12', label: 'ğŸ›° Hybrid'   },
  { id: 'mapbox://styles/mapbox/light-v11',             label: 'â˜ï¸ Light'    },
  { id: 'mapbox://styles/mapbox/dark-v11',              label: 'ğŸŒ™ Dark'     },
];
const HYBRID_IDX = 3;
(function buildStyleSelect() {
  const el = document.getElementById('styleSelect');
  MAP_STYLES.forEach((s, i) => {
    const o = document.createElement('option');
    o.value = i; o.textContent = s.label;
    if (i === HYBRID_IDX) o.selected = true;
    el.appendChild(o);
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = new mapboxgl.Map({
  container: 'map',
  style: MAP_STYLES[HYBRID_IDX].id,
  center: [-98.35, 39.5],
  zoom: 4,
  doubleClickZoom: false,
  boxZoom: false,
});
map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
map.addControl(new mapboxgl.ScaleControl({ maxWidth: 120 }), 'bottom-left');

function resetNorth() { map.easeTo({ bearing: 0, pitch: 0, duration: 500 }); }
map.on('rotate', () => {
  document.getElementById('northBtn').style.opacity = Math.abs(map.getBearing()) > 1 ? '1' : '0.6';
});

function changeMapStyle(idx) {
  polygons.forEach(p => _removeZoneLabel(p));
  map.setStyle(MAP_STYLES[parseInt(idx)].id);
}

map.on('style.load', () => {
  _initDrawLayers();
  _restoreAllZoneLayers();
  polygons.forEach(p => _addZoneLabel(p));
  if (_pendingCountyGeoJSON) _readdCountyLayer(_pendingCountyGeoJSON);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW LAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _initDrawLayers() {
  function addSrc(id, type) {
    if (map.getSource(id)) return;
    const empty = type === 'Polygon'
      ? { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[[]] } }
      : type === 'LineString'
      ? { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:[] } }
      : { type:'FeatureCollection', features:[] };
    map.addSource(id, { type:'geojson', data: empty });
  }
  addSrc(SRC_FILL, 'Polygon');
  addSrc(SRC_LINE, 'LineString');
  addSrc(SRC_PREVIEW, 'LineString');
  addSrc(SRC_VERTS, 'FeatureCollection');

  if (!map.getLayer(SRC_FILL))
    map.addLayer({ id:SRC_FILL, type:'fill', source:SRC_FILL, paint:{'fill-color':['get','color'],'fill-opacity':0.12} });
  if (!map.getLayer(SRC_LINE))
    map.addLayer({ id:SRC_LINE, type:'line', source:SRC_LINE, paint:{'line-color':['get','color'],'line-width':2.5,'line-dasharray':[2,2]} });
  if (!map.getLayer(SRC_PREVIEW))
    map.addLayer({ id:SRC_PREVIEW, type:'line', source:SRC_PREVIEW, paint:{'line-color':['get','color'],'line-width':1.5,'line-dasharray':[2,3]} });
  if (!map.getLayer(SRC_VERTS))
    map.addLayer({ id:SRC_VERTS, type:'circle', source:SRC_VERTS, paint:{'circle-radius':4,'circle-color':['get','color'],'circle-stroke-color':'#fff','circle-stroke-width':1.5} });
}

function _setDrawSrc(id, data) { if (map.getSource(id)) map.getSource(id).setData(data); }
function _emptyPoly()   { return { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[[]] } }; }
function _emptyLine()   { return { type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates:[] } }; }
function _emptyPts()    { return { type:'FeatureCollection', features:[] }; }
function _clearPreviews() {
  _setDrawSrc(SRC_FILL, _emptyPoly());
  _setDrawSrc(SRC_LINE, _emptyLine());
  _setDrawSrc(SRC_PREVIEW, _emptyLine());
  _setDrawSrc(SRC_VERTS, _emptyPts());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE LAYER MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _srcId  = id => 'zone-src-'  + id;
const _fillId = id => 'zone-fill-' + id;
const _lineId = id => 'zone-line-' + id;

function _addZoneLayers(poly) {
  const { id, color, points } = poly;
  const gj = { type:'Feature', properties:{ color }, geometry:{ type:'Polygon', coordinates:[[...points, points[0]]] } };
  if (!map.getSource(_srcId(id))) map.addSource(_srcId(id), { type:'geojson', data: gj });
  else map.getSource(_srcId(id)).setData(gj);
  if (!map.getLayer(_fillId(id)))
    map.addLayer({ id:_fillId(id), type:'fill', source:_srcId(id), paint:{'fill-color':color,'fill-opacity':0.2} });
  if (!map.getLayer(_lineId(id)))
    map.addLayer({ id:_lineId(id), type:'line', source:_srcId(id), paint:{'line-color':color,'line-width':2} });
  map.on('click', _fillId(id), e => { e.preventDefault(); openZoneDescModal(id); });
  map.on('mouseenter', _fillId(id), () => { if (!drawMode) map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', _fillId(id), () => { if (!drawMode) map.getCanvas().style.cursor = ''; });
}
function _removeZoneLayers(id) {
  if (map.getLayer(_fillId(id))) map.removeLayer(_fillId(id));
  if (map.getLayer(_lineId(id))) map.removeLayer(_lineId(id));
  if (map.getSource(_srcId(id))) map.removeSource(_srcId(id));
}
function _restoreAllZoneLayers() { polygons.forEach(p => _addZoneLayers(p)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE LABELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _addZoneLabel(poly) {
  _removeZoneLabel(poly);
  const el = document.createElement('div');
  el.className = 'zone-label';
  el.innerHTML = `<span class="zl-letter">${poly.letter||''}</span><span class="zl-name">${poly.name||''}</span>`;
  const lngs = poly.points.map(p=>p[0]), lats = poly.points.map(p=>p[1]);
  const center = [(Math.min(...lngs)+Math.max(...lngs))/2, (Math.min(...lats)+Math.max(...lats))/2];
  poly.labelMarker = new mapboxgl.Marker({ element:el, anchor:'center' }).setLngLat(center).addTo(map);
}
function _removeZoneLabel(poly) {
  if (poly.labelMarker) { poly.labelMarker.remove(); poly.labelMarker = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pixelDist(a, b) {
  const pa = map.project(a), pb = map.project(b);
  return Math.hypot(pa.x-pb.x, pa.y-pb.y);
}

function cancelDraw() {
  drawMode = null; polyState = 'idle'; drawPoints = [];
  _clearPreviews();
  map.dragPan.enable(); map.boxZoom.enable();
  map.getCanvas().style.cursor = '';
  document.getElementById('btnPolygon').classList.remove('active');
  document.getElementById('btnCancel').style.display = 'none';
  document.getElementById('drawHint').style.display = 'none';
  document.getElementById('drawHelp').textContent = 'Select a state & county above, then click Draw Polygon.';
}

function startDraw() {
  cancelDraw();
  drawMode = 'polygon'; polyState = 'drawing';
  map.getCanvas().style.cursor = 'crosshair';
  document.getElementById('btnPolygon').classList.add('active');
  document.getElementById('btnCancel').style.display = 'block';
  const hint = document.getElementById('drawHint');
  hint.style.display = 'block';
  hint.textContent = 'ğŸ“ Click to add vertices â€” click first point to close';
  document.getElementById('drawHelp').textContent = 'Click to place vertices. Click the first point to close.';
}

map.on('click', function(e) {
  if (window.innerWidth <= 700) document.getElementById('sidebar').classList.remove('open');
  if (drawMode !== 'polygon' || polyState !== 'drawing') return;
  const pt = [e.lngLat.lng, e.lngLat.lat];
  if (drawPoints.length >= 3 && pixelDist(pt, drawPoints[0]) <= 10) { _finishPolygon(); return; }
  drawPoints.push(pt);
  _refreshPolyPreviews(null);
});

map.on('mousemove', function(e) {
  if (drawMode !== 'polygon' || polyState !== 'drawing' || !drawPoints.length) return;
  const cursor = [e.lngLat.lng, e.lngLat.lat];
  const nearClose = drawPoints.length >= 3 && pixelDist(cursor, drawPoints[0]) <= 10;
  map.getCanvas().style.cursor = nearClose ? 'pointer' : 'crosshair';
  _refreshPolyPreviews(cursor, nearClose);
});

function _refreshPolyPreviews(cur, nearClose) {
  const color = selectedColor;
  _setDrawSrc(SRC_LINE, drawPoints.length >= 2
    ? { type:'Feature', properties:{color}, geometry:{ type:'LineString', coordinates:drawPoints } }
    : _emptyLine());
  _setDrawSrc(SRC_FILL, drawPoints.length >= 3
    ? { type:'Feature', properties:{color}, geometry:{ type:'Polygon', coordinates:[[...drawPoints, drawPoints[0]]] } }
    : _emptyPoly());
  if (cur && drawPoints.length >= 1) {
    const pc = nearClose ? '#00ff88' : color;
    _setDrawSrc(SRC_PREVIEW, { type:'Feature', properties:{color:pc}, geometry:{ type:'LineString', coordinates:[drawPoints[drawPoints.length-1], cur] } });
    if (map.getLayer(SRC_PREVIEW)) {
      map.setPaintProperty(SRC_PREVIEW, 'line-color', pc);
      map.setPaintProperty(SRC_PREVIEW, 'line-width', nearClose ? 2.5 : 1.5);
      map.setPaintProperty(SRC_PREVIEW, 'line-dasharray', nearClose ? [1] : [2,3]);
    }
  } else { _setDrawSrc(SRC_PREVIEW, _emptyLine()); }
  _setDrawSrc(SRC_VERTS, {
    type:'FeatureCollection',
    features: drawPoints.map((p, i) => ({ type:'Feature', properties:{color: i===0 ? '#00ff88' : color}, geometry:{ type:'Point', coordinates:p } }))
  });
}

function _finishPolygon() {
  if (drawPoints.length < 3) { showToast('Need at least 3 points', 'error'); return; }
  const pts = drawPoints.slice();
  const color = selectedColor;
  cancelDraw();
  createPolygonAuto(pts, color);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LETTER MANAGEMENT â€” per county
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _nextLetterForCounty(stateAbbr, countyName) {
  const used = new Set(
    polygons.filter(p => p.stateAbbr === stateAbbr && p.countyName === countyName).map(p => p.letter).filter(Boolean)
  );
  for (let i = 0; i < 26; i++) {
    const l = String.fromCharCode(65 + i);
    if (!used.has(l)) return l;
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE POLYGON (auto-named, no modal)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createPolygonAuto(pts, color) {
  const stateAbbr  = document.getElementById('stateSelect').value || '';
  const countyName = document.getElementById('countySelect').value || '';
  if (!stateAbbr || !countyName) {
    showToast('Please select a State and County before drawing a zone.', 'error');
    return;
  }
  const letter = _nextLetterForCounty(stateAbbr, countyName);
  if (!letter) { showToast('Max 26 zones per county (Aâ€“Z). Delete a zone first.', 'error'); return; }
  const name = `${countyName} County, ${stateAbbr}`;
  const poly = {
    id: 'poly_' + Date.now(), name, letter, stateAbbr, countyName,
    color, points: pts, description: '', labelMarker: null, handles: [],
    _isRect: false, _bounds: null,
  };
  polygons.push(poly);
  _addZoneLayers(poly);
  _addZoneLabel(poly);
  renderPolygonList();
  persistZones();
  showToast(`Zone ${letter} created â€” ${name}`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE DESCRIPTION MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openZoneDescModal(polyId) {
  const p = polygons.find(p => p.id === polyId);
  if (!p) return;
  _editingDescId = polyId;
  document.getElementById('zoneDescTitle').textContent = `ZONE ${p.letter} â€” ${p.name}`;
  document.getElementById('zoneDescSubtitle').textContent = 'Add pricing zone notes or a description below.';
  document.getElementById('zoneDescInput').value = p.description || '';
  document.getElementById('zoneDescModal').classList.add('open');
  setTimeout(() => document.getElementById('zoneDescInput').focus(), 100);
}
function closeZoneDescModal() {
  document.getElementById('zoneDescModal').classList.remove('open');
  _editingDescId = null;
}
function saveZoneDesc() {
  if (!_editingDescId) return;
  const p = polygons.find(p => p.id === _editingDescId);
  if (p) { p.description = document.getElementById('zoneDescInput').value.trim(); persistZones(); showToast('Notes saved', 'success'); }
  closeZoneDescModal();
}
document.getElementById('zoneDescModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeZoneDescModal(); });
document.getElementById('zoneDescInput').addEventListener('keydown', e => { if (e.key === 'Escape') closeZoneDescModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER POLYGON LIST â€” Full State Name â†’ County hierarchy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPolygonList() {
  document.getElementById('zoneCount').textContent = polygons.length;
  document.getElementById('statPolygons').textContent = polygons.length;
  const stateSet = new Set(polygons.map(p => p.stateAbbr).filter(Boolean));
  document.getElementById('statStates').textContent = stateSet.size;

  const list = document.getElementById('polygonsList');
  if (!polygons.length) {
    list.innerHTML = '<div class="empty-state">No zones yet.<br>Select a state &amp; county,<br>then draw on the map.</div>';
    return;
  }

  // Group by stateAbbr â†’ countyName
  const byState = {};
  polygons.forEach(p => {
    const sa = p.stateAbbr || 'Unknown';
    const cn = p.countyName || 'Unknown';
    if (!byState[sa]) byState[sa] = {};
    if (!byState[sa][cn]) byState[sa][cn] = [];
    byState[sa][cn].push(p);
  });

  list.innerHTML = '';
  Object.keys(byState).sort().forEach(stateAbbr => {
    const fullName = abbrToFullName(stateAbbr);
    const totalZones = Object.values(byState[stateAbbr]).reduce((a,b) => a+b.length, 0);

    const stateDiv = document.createElement('div');
    stateDiv.className = 'state-group';

    const hdr = document.createElement('div');
    hdr.className = 'state-header open';
    hdr.innerHTML = `<span class="sg-arrow">â–¶</span><span style="flex:1">${fullName}</span><span style="font-size:10px;color:var(--muted);font-weight:400">${totalZones} zone${totalZones!==1?'s':''}</span>`;
    hdr.onclick = () => { hdr.classList.toggle('open'); countiesDiv.classList.toggle('open'); };

    const countiesDiv = document.createElement('div');
    countiesDiv.className = 'state-counties open';

    Object.keys(byState[stateAbbr]).sort().forEach(countyName => {
      const cPolys = byState[stateAbbr][countyName];
      const cGroup = document.createElement('div');
      cGroup.className = 'county-group';

      const cHdr = document.createElement('div');
      cHdr.className = 'county-header';
      cHdr.innerHTML = `
        <span style="flex:1">${countyName} County</span>
        <span style="font-size:10px;margin-right:4px;font-weight:400">${cPolys.length}z</span>
        <button class="poly-btn" title="Delete county zones" style="font-size:11px" onclick="deleteCounty('${stateAbbr}','${CSS.escape(countyName)}',event)">ğŸ—‘</button>
      `;
      cHdr.onclick = e => {
        if (e.target.classList.contains('poly-btn') || e.target.closest('.poly-btn')) return;
        navigateToCounty(stateAbbr, countyName);
      };

      const polyDiv = document.createElement('div');
      polyDiv.className = 'county-polys';

      cPolys.forEach(p => {
        const div = document.createElement('div');
        div.className = 'polygon-item';
        div.innerHTML = `
          <div style="width:12px;height:12px;border-radius:3px;background:${p.color};flex-shrink:0"></div>
          <div class="poly-info">
            <div class="poly-name">ZONE ${p.letter}</div>
            <div class="poly-count">${p.propCount != null ? p.propCount+' props' : 'not assigned'}</div>
          </div>
          <button class="poly-btn" title="Notes" onclick="openZoneDescModal('${p.id}');event.stopPropagation()">ğŸ“</button>
          <button class="poly-btn" title="Delete" onclick="deletePoly('${p.id}');event.stopPropagation()">âœ•</button>
        `;
        div.onclick = () => zoomToZoneAndCounty(p);
        polyDiv.appendChild(div);
      });

      cGroup.appendChild(cHdr);
      cGroup.appendChild(polyDiv);
      countiesDiv.appendChild(cGroup);
    });

    stateDiv.appendChild(hdr);
    stateDiv.appendChild(countiesDiv);
    list.appendChild(stateDiv);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTY NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function navigateToCounty(stateAbbr, countyName) {
  const ss = document.getElementById('stateSelect');
  const cs = document.getElementById('countySelect');
  ss.value = stateAbbr;
  await loadCounties(true);
  cs.value = countyName;
  saveAppState();
  await loadCounty(); // also fits bounds
}

async function zoomToZoneAndCounty(poly) {
  // Zoom to zone polygon
  const b = new mapboxgl.LngLatBounds();
  poly.points.forEach(pt => b.extend(pt));
  map.fitBounds(b, { padding: 80 });

  // Update sidebar selectors
  if (poly.stateAbbr && poly.countyName) {
    const ss = document.getElementById('stateSelect');
    const cs = document.getElementById('countySelect');
    ss.value = poly.stateAbbr;
    await loadCounties(true);
    cs.value = poly.countyName;
    saveAppState();
    // Show county boundary without refitting the map view
    await loadCountyBoundaryOnly(poly.stateAbbr, poly.countyName);
  }
}

async function loadCountyBoundaryOnly(stateAbbr, countyName) {
  try {
    const fips = STATE_FIPS[stateAbbr];
    if (!fips) return;
    const url = `https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_Current/MapServer/82/query?where=STATE%3D'${fips}'%20AND%20BASENAME%3D'${encodeURIComponent(countyName)}'&outFields=*&f=geojson`;
    const geojson = await (await fetch(url)).json();
    if (!geojson.features || !geojson.features.length) return;
    _pendingCountyGeoJSON = geojson;
    _readdCountyLayer(geojson);
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deletePoly(id, skipConfirm) {
  const i = polygons.findIndex(p => p.id === id);
  if (i === -1) return;
  const p = polygons[i];
  if (!skipConfirm && !confirm(`Are you sure you want to delete Zone ${p.letter} (${p.name})?\n\nThis action cannot be undone.`)) return;
  _removeZoneLabel(p);
  if (p.handles) p.handles.forEach(h => { if (h && h.remove) h.remove(); });
  _removeZoneLayers(id);
  properties.forEach(prop => { if (prop.zone === p.name) { _markerColor(prop.marker, '#f7c948'); prop.zone = null; } });
  polygons.splice(i, 1);
  renderPolygonList(); persistZones();
}

function deleteCounty(stateAbbr, countyName, evt) {
  if (evt) evt.stopPropagation();
  const toDelete = polygons.filter(p => p.stateAbbr === stateAbbr && p.countyName === countyName);
  if (!toDelete.length) return;
  if (!confirm(`Delete all ${toDelete.length} zone${toDelete.length>1?'s':''} in ${countyName} County, ${abbrToFullName(stateAbbr)}?\n\nThis action cannot be undone.`)) return;
  toDelete.forEach(p => {
    _removeZoneLabel(p);
    if (p.handles) p.handles.forEach(h => { if (h && h.remove) h.remove(); });
    _removeZoneLayers(p.id);
    properties.forEach(prop => { if (prop.zone === p.name) { _markerColor(prop.marker, '#f7c948'); prop.zone = null; } });
  });
  polygons = polygons.filter(p => !(p.stateAbbr === stateAbbr && p.countyName === countyName));
  renderPolygonList(); persistZones();
}

function clearAllZones() {
  if (!polygons.length) return;
  if (!confirm('Delete ALL zones? This cannot be undone.')) return;
  polygons.forEach(p => { _removeZoneLabel(p); if (p.handles) p.handles.forEach(h=>{if(h&&h.remove)h.remove();}); _removeZoneLayers(p.id); });
  polygons = [];
  properties.forEach(prop => { if (prop.zone) { _markerColor(prop.marker, '#f7c948'); prop.zone = null; } });
  renderPolygonList(); persistZones();
  showToast('All zones cleared', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSIST ZONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _polyToJSON(p) {
  return { id:p.id, name:p.name, letter:p.letter||'', stateAbbr:p.stateAbbr||'', countyName:p.countyName||'',
           color:p.color, points:p.points, description:p.description||'', isRect:!!p._isRect, bounds:p._bounds||null };
}
function persistZones() {
  try { localStorage.setItem('geofence_zones', JSON.stringify(polygons.map(_polyToJSON))); } catch(e) {}
}
function restoreZones() {
  try {
    const raw = localStorage.getItem('geofence_zones'); if (!raw) return;
    const data = JSON.parse(raw);
    data.forEach(d => _loadZone(d));
    renderPolygonList();
    if (data.length) showToast(`Restored ${data.length} zone${data.length>1?'s':''}`, 'success');
  } catch(e) {}
}
function _loadZone(d) {
  const poly = { id:d.id, name:d.name, letter:d.letter||'', stateAbbr:d.stateAbbr||'', countyName:d.countyName||'',
    color:d.color, points:d.points, description:d.description||'', labelMarker:null, handles:[], _isRect:d.isRect||false, _bounds:d.bounds||null };
  // Back-compat: derive stateAbbr/countyName from name if missing
  if (!poly.stateAbbr || !poly.countyName) {
    const m = poly.name.match(/^(.+) County,\s*([A-Z]{2})$/);
    if (m) { poly.countyName = m[1]; poly.stateAbbr = m[2]; }
    else { const m2 = poly.name.match(/^(.+),\s*([A-Z]{2})$/); if(m2){poly.countyName=m2[1];poly.stateAbbr=m2[2];} }
  }
  polygons.push(poly);
  _addZoneLayers(poly);
  _addZoneLabel(poly);
  return poly;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / LOAD ZONES FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveZonesFile() {
  if (!polygons.length) { showToast('No zones to save', 'error'); return; }
  const blob = new Blob([JSON.stringify({ version:2, saved:new Date().toISOString(), zones:polygons.map(_polyToJSON) }, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `countyzone-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showToast('Zones file downloaded!', 'success');
}
function loadZonesFile() { document.getElementById('zoneFileInput').click(); }
function importZonesFile(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      const zones = data.zones || data;
      if (!Array.isArray(zones)) throw new Error();
      polygons.forEach(p => { _removeZoneLabel(p); if(p.handles)p.handles.forEach(h=>{if(h&&h.remove)h.remove();}); _removeZoneLayers(p.id); });
      polygons = [];
      zones.forEach(d => _loadZone(d));
      renderPolygonList(); persistZones();
      showToast(`Loaded ${zones.length} zone${zones.length!==1?'s':''}`, 'success');
      if (polygons.length) {
        const b = new mapboxgl.LngLatBounds();
        polygons.forEach(p => p.points.forEach(pt => b.extend(pt)));
        map.fitBounds(b, { padding:60 });
      }
    } catch(err) { showToast('Could not read zones file', 'error'); }
    e.target.value = '';
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARE URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shareURL() {
  if (!polygons.length) { showToast('Draw some zones first', 'error'); return; }
  const encoded = btoa(encodeURIComponent(JSON.stringify(polygons.map(_polyToJSON))));
  const url = window.location.origin + window.location.pathname + '?zones=' + encoded;
  if (url.length > 8000) { showToast('Too many zones â€” use Save Zones file instead', 'error'); return; }
  navigator.clipboard.writeText(url).then(() => showToast('Share link copied!', 'success')).catch(() => {
    const b = document.getElementById('shareBanner');
    b.textContent = 'ğŸ”— ' + url; b.style.display = 'block';
    setTimeout(() => b.style.display = 'none', 8000);
  });
}
function copyShareURL() {
  const b = document.getElementById('shareBanner');
  navigator.clipboard.writeText(b.textContent.replace('ğŸ”— ','')).then(() => { showToast('Copied!','success'); b.style.display='none'; });
}
function loadZonesFromURL() {
  try {
    const enc = new URLSearchParams(window.location.search).get('zones');
    if (!enc) return false;
    JSON.parse(decodeURIComponent(atob(enc))).forEach(d => _loadZone(d));
    renderPolygonList();
    if (polygons.length) {
      const b = new mapboxgl.LngLatBounds();
      polygons.forEach(p => p.points.forEach(pt => b.extend(pt)));
      map.fitBounds(b, { padding:60 });
      showToast(`Loaded ${polygons.length} shared zone${polygons.length!==1?'s':''}`, 'success');
    }
    return true;
  } catch(e) { return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSheetsModal()  { document.getElementById('sheetsModal').classList.add('open'); }
function closeSheetsModal() { document.getElementById('sheetsModal').classList.remove('open'); }
async function connectSheets() {
  const sheetId = document.getElementById('sheetId').value.trim();
  if (!sheetId) { showToast('Please enter a Spreadsheet ID', 'error'); return; }
  sheetConfig = {
    sheetId,
    sheetName: document.getElementById('sheetName').value.trim() || 'Sheet1',
    colLat:  document.getElementById('colLat').value.trim()  || 'latitude',
    colLng:  document.getElementById('colLng').value.trim()  || 'longitude',
    colAPN:  document.getElementById('colAPN').value.trim()  || 'APN',
    colCity: document.getElementById('colCity').value.trim() || 'city',
    colState:document.getElementById('colState').value.trim()|| 'state',
    colZip:  document.getElementById('colZip').value.trim()  || 'zip',
    colZone: document.getElementById('colZone').value.trim() || 'Zone',
  };
  try { localStorage.setItem('geofence_sheet_config', JSON.stringify(sheetConfig)); } catch(e) {}
  showToast('Connecting to Google Sheets...', 'info');
  try {
    const url = `https://docs.google.com/spreadsheets/d/${sheetConfig.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetConfig.sheetName)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    parseAndLoad(await r.text());
    setConnected(true); closeSheetsModal();
  } catch(e) { showToast('Connection failed â€” check sharing settings', 'error'); }
}
function parseAndLoad(csv) {
  const rows = parseCSV(csv);
  if (rows.length < 2) { showToast('Sheet appears empty', 'error'); return; }
  const headers = rows[0];
  const { colLat, colLng, colAPN, colCity, colState, colZip } = sheetConfig;
  const idx = n => headers.indexOf(n);
  const latIdx = idx(colLat), lngIdx = idx(colLng);
  if (latIdx===-1||lngIdx===-1) { showToast(`Columns "${colLat}" or "${colLng}" not found.`, 'error'); return; }
  properties.forEach(p => { if (p.marker) p.marker.remove(); });
  properties = []; let loaded = 0;
  rows.slice(1).forEach((row, i) => {
    const lat = parseFloat(row[latIdx]), lng = parseFloat(row[lngIdx]);
    if (isNaN(lat)||isNaN(lng)) return;
    const apn  = idx(colAPN)!==âˆ’1  ? row[idx(colAPN)]  : `Row ${i+2}`;
    const city = idx(colCity)!==-1 ? row[idx(colCity)] : '';
    const st   = idx(colState)!==-1? row[idx(colState)]: '';
    const zip  = idx(colZip)!==-1  ? row[idx(colZip)]  : '';
    const loc  = [city,st,zip].filter(Boolean).join(', ');
    const popup = new mapboxgl.Popup({ offset:8 }).setHTML(
      `<div style="font-family:'DM Sans',sans-serif;font-size:12px;line-height:1.9;background:#111827;color:#e8f0fe;padding:6px 10px;border-radius:6px">
        <strong style="color:#00e5ff">APN: ${apn}</strong><br>
        ${loc?`<span>${loc}</span><br>`:''}
        <span style="color:#6b7a99;font-size:10px">${lat.toFixed(5)}, ${lng.toFixed(5)}</span>
      </div>`
    );
    const el = document.createElement('div');
    el.style.cssText = 'width:10px;height:10px;border-radius:50%;background:#f7c948;border:1.5px solid rgba(0,0,0,0.4);cursor:pointer;';
    const marker = new mapboxgl.Marker({element:el}).setLngLat([lng,lat]).setPopup(popup).addTo(map);
    properties.push({ row, headers, lat, lng, apn, city, state:st, zip, marker, zone:null });
    loaded++;
  });
  document.getElementById('statProps').textContent = loaded;
  showToast(`Loaded ${loaded} properties`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZONE ASSIGNMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pointInPolygon(lat, lng, pts) {
  const x=lng,y=lat; let inside=false;
  for(let i=0,j=pts.length-1;i<pts.length;j=i++){
    const xi=pts[i][0],yi=pts[i][1],xj=pts[j][0],yj=pts[j][1];
    if(((yi>y)!==(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi)) inside=!inside;
  }
  return inside;
}
function runAssignment() {
  if (!polygons.length) { showToast('Draw at least one zone first', 'error'); return; }
  if (!properties.length) { showToast('No properties loaded. Connect Google Sheets first.', 'error'); return; }
  polygons.forEach(p => p.propCount = 0);
  let assigned = 0;
  properties.forEach(prop => {
    prop.zone = null;
    for (const poly of polygons) {
      if (pointInPolygon(prop.lat, prop.lng, poly.points)) {
        prop.zone = poly.name; poly.propCount++;
        _markerColor(prop.marker, poly.color);
        assigned++; break;
      }
    }
    if (!prop.zone) _markerColor(prop.marker, '#f7c948');
  });
  document.getElementById('statAssigned').textContent = assigned;
  renderPolygonList();
  showToast(`${assigned} of ${properties.length} properties assigned`, 'success');
}
function _markerColor(m, c) { if (m) m.getElement().style.background = c; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (!properties.length) { showToast('No properties to export', 'error'); return; }
  const zoneCol = sheetConfig.colZone || 'Zone';
  const headers = [...properties[0].headers];
  if (!headers.includes(zoneCol)) headers.push(zoneCol);
  const zi = headers.indexOf(zoneCol);
  const rows = [headers.map(ce).join(',')];
  properties.forEach(prop => {
    const row = [...prop.row];
    while (row.length < headers.length) row.push('');
    row[zi] = prop.zone || '';
    rows.push(row.map(ce).join(','));
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([rows.join('\n')], {type:'text/csv'}));
  a.download = 'properties_with_zones.csv'; a.click();
  showToast('CSV downloaded!', 'success');
}
function ce(v) {
  if (v==null) return '';
  const s = String(v);
  return (s.includes(',')||s.includes('"')||s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
}
function parseCSV(text) {
  const rows = [];
  text.split('\n').forEach(line => {
    if (!line.trim()) return;
    const row=[]; let cur='',inQ=false;
    for(let i=0;i<line.length;i++){
      if(line[i]==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
      else if(line[i]===','&&!inQ){row.push(cur.trim());cur='';}
      else cur+=line[i];
    }
    row.push(cur.trim()); rows.push(row);
  });
  return rows;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTY BOUNDARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const stateSelect = document.getElementById('stateSelect');
STATES.forEach(([name, abbr]) => {
  const o = document.createElement('option'); o.value = abbr; o.textContent = name;
  stateSelect.appendChild(o);
});

async function loadCounties(silent) {
  const abbr = stateSelect.value; if (!abbr) return;
  const cs = document.getElementById('countySelect');
  if (!silent) cs.innerHTML = '<option value="">Loading counties...</option>';
  function fill(counties) {
    cs.innerHTML = '<option value="">â€” Select County â€”</option>';
    counties.forEach(n => { const o=document.createElement('option'); o.value=n; o.textContent=n+' County'; cs.appendChild(o); });
    if (!silent) { const s=loadAppState(); if(s&&s.state===abbr&&s.county) cs.value=s.county; }
  }
  try {
    const cached = localStorage.getItem('counties_'+abbr);
    if (cached) {
      const p = JSON.parse(cached);
      if (p.counties&&p.abbr===abbr&&Date.now()-p.ts<30*24*60*60*1000) { fill(p.counties); return; }
      localStorage.removeItem('counties_'+abbr);
    }
  } catch(e) {}
  try {
    const fips = STATE_FIPS[abbr];
    const data = await (await fetch(`https://api.census.gov/data/2020/dec/pl?get=NAME&for=county:*&in=state:${fips}`)).json();
    const stateName = STATES.find(s=>s[1]===abbr)[0];
    const counties = data.slice(1).map(row=>row[0].replace(`, ${stateName}`,'').replace(/ County$/,'').trim()).sort();
    try { localStorage.setItem('counties_'+abbr, JSON.stringify({counties,abbr,ts:Date.now()})); } catch(e) {}
    fill(counties);
  } catch(e) {
    try { const s=localStorage.getItem('counties_'+abbr); if(s){fill(JSON.parse(s).counties);return;} } catch(e2){}
    if (!silent) cs.innerHTML='<option value="">Failed to load</option>';
  }
}

function _removeCountyLayer() {
  if (!countySourceId) return;
  if (map.getLayer(countySourceId+'-fill')) map.removeLayer(countySourceId+'-fill');
  if (map.getLayer(countySourceId+'-line')) map.removeLayer(countySourceId+'-line');
  if (map.getSource(countySourceId))        map.removeSource(countySourceId);
  countySourceId = null;
}
function _readdCountyLayer(geojson) {
  if (countySourceId) {
    if (map.getLayer(countySourceId+'-fill')) map.removeLayer(countySourceId+'-fill');
    if (map.getLayer(countySourceId+'-line')) map.removeLayer(countySourceId+'-line');
    if (map.getSource(countySourceId))        map.removeSource(countySourceId);
  }
  countySourceId = 'county-' + Date.now();
  map.addSource(countySourceId, { type:'geojson', data:geojson });
  map.addLayer({ id:countySourceId+'-fill', type:'fill', source:countySourceId, paint:{'fill-color':'#000000','fill-opacity':0.12} });
  map.addLayer({ id:countySourceId+'-line', type:'line', source:countySourceId, paint:{'line-color':'#6600cc','line-width':3} });
}

async function loadCounty() {
  const abbr = stateSelect.value, county = document.getElementById('countySelect').value;
  saveAppState(); if (!abbr||!county) return;
  _removeCountyLayer();
  showToast('Loading county boundary...', 'info');
  try {
    const fips = STATE_FIPS[abbr];
    const url = `https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_Current/MapServer/82/query?where=STATE%3D'${fips}'%20AND%20BASENAME%3D'${encodeURIComponent(county)}'&outFields=*&f=geojson`;
    const geojson = await (await fetch(url)).json();
    if (!geojson.features||!geojson.features.length) { showToast('County boundary not found','error'); return; }
    _pendingCountyGeoJSON = geojson;
    _readdCountyLayer(geojson);
    const bounds = new mapboxgl.LngLatBounds();
    geojson.features.forEach(f => {
      const coords = f.geometry.type==='Polygon' ? f.geometry.coordinates.flat()
                   : f.geometry.type==='MultiPolygon' ? f.geometry.coordinates.flat(2) : [];
      coords.forEach(c => bounds.extend(c));
    });
    map.fitBounds(bounds, { padding:40 });
    showToast(`${county} County loaded`, 'success');
  } catch(e) { showToast('Could not load county boundary', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setConnected(v) {
  document.getElementById('statusDot').className = 'status-dot'+(v?' on':'');
  document.getElementById('statusText').textContent = v ? 'SHEET CONNECTED' : 'NOT CONNECTED';
}
let toastTimer;
function showToast(msg, type='info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast '+type+' show';
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 4500);
}
function saveAppState() {
  try { localStorage.setItem('geofence_app_state', JSON.stringify({state:stateSelect.value, county:document.getElementById('countySelect').value})); } catch(e) {}
}
function loadAppState() {
  try { return JSON.parse(localStorage.getItem('geofence_app_state')); } catch(e) { return null; }
}

document.getElementById('sheetsModal').addEventListener('click', e => { if (e.target===e.currentTarget) closeSheetsModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
map.on('load', () => {
  _initDrawLayers();
  const fromURL = loadZonesFromURL();
  if (!fromURL) restoreZones();
  try {
    const cfg = JSON.parse(localStorage.getItem('geofence_sheet_config'));
    if (cfg) {
      sheetConfig = cfg;
      document.getElementById('sheetId').value    = cfg.sheetId    || '';
      document.getElementById('sheetName').value  = cfg.sheetName  || 'Sheet1';
      document.getElementById('colLat').value     = cfg.colLat     || 'latitude';
      document.getElementById('colLng').value     = cfg.colLng     || 'longitude';
      document.getElementById('colAPN').value     = cfg.colAPN     || 'APN';
      document.getElementById('colCity').value    = cfg.colCity    || 'city';
      document.getElementById('colState').value   = cfg.colState   || 'state';
      document.getElementById('colZip').value     = cfg.colZip     || 'zip';
      document.getElementById('colZone').value    = cfg.colZone    || 'Zone';
    }
  } catch(e) {}
  const appState = loadAppState();
  if (appState && appState.state) {
    stateSelect.value = appState.state;
    loadCounties().then(() => {
      if (appState.county) document.getElementById('countySelect').value = appState.county;
    });
  }
});
</script>
</body>
</html>
